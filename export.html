<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>UAT JSON Export (verbatim plan/planned)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { --bg:#0b1620; --panel:#0f2233; --text:#d9e7ff; --muted:#8fb3d9; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  h1{font-size:22px;margin:20px 0 10px}
  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  .card{background:#0f2233;border-radius:10px;padding:16px;margin:12px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  label{display:inline-flex;align-items:center;gap:8px}
  input,select{background:#07121a;color:var(--text);border:1px solid #15314b;border-radius:8px;padding:8px 10px}
  input[type=file]{padding:6px}
  pre{white-space:pre-wrap;background:#07121a;border-radius:10px;padding:14px;overflow:auto;max-height:50vh}
  button{border:0;border-radius:8px;padding:10px 14px;color:#001a2c;background:linear-gradient(135deg,#6dd5fa,#2980b9);cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .muted{color:var(--muted)}
  .small{font-size:12px}
</style>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>UAT JSON Export</h1>

  <div class="card">
    <h3>1) Workbook & Header</h3>
    <div class="row">
      <input id="file" type="file" accept=".xlsx" />
      <span id="status" class="muted"></span>
    </div>
    <div class="row" style="margin-top:10px">
      <label>As of:
        <input id="asof" type="text" placeholder="YYYY-MM-DD HH:mm">
      </label>
      <label>Info URL:
        <input id="infoUrl" type="text" placeholder="./about-uat.md" value="./about-uat.md">
      </label>
      <label>Daily Status URL:
        <input id="statusUrl" type="text" placeholder="./daily-status.md" value="./daily-status.md">
      </label>
    </div>
    <div class="row" style="margin-top:10px">
      <label>Health:
        <select id="healthStatus">
          <option value="auto">auto (let app compute)</option>
          <option value="green">green (On Track)</option>
          <option value="amber">amber (At Risk)</option>
          <option value="red">red (Off Track)</option>
        </select>
      </label>
      <label>Comment:
        <input id="healthComment" type="text" placeholder="optional note for non-green">
      </label>
    </div>
    <div class="small muted" style="margin-top:6px">
      Sheets used: <code>overview</code> (release), <code>plan</code>, <code>planned</code>, <code>testDaily</code>, <code>defectsDaily</code>, <code>issues</code>, <code>keyDates</code>.
      Plan & planned are copied verbatim (no auto generation).
    </div>
  </div>

  <div class="card">
    <h3>2) Preview</h3>
    <pre id="preview">// (no preview)</pre>
  </div>

  <div class="card">
    <h3>3) Export</h3>
    <div class="row">
      <button id="dlJson" disabled>Download uat.json</button>
      <button id="dlBackup" disabled>Download backup</button>
    </div>
  </div>
</div>

<script>
(function(){
  // -------- DOM --------
  const $ = s => document.querySelector(s);
  const statusEl = $('#status'), preview = $('#preview');
  const btnJson = $('#dlJson'), btnBak = $('#dlBackup');
  const $asof = $('#asof'), $info = $('#infoUrl'), $stUrl = $('#statusUrl'), $hStat = $('#healthStatus'), $hCmt = $('#healthComment');

  // seed asOf to now
  (function(){
    const d=new Date(); const pad=n=>n<10?'0'+n:n;
    $asof.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  })();

  let lastText = '';

  // -------- helpers --------
  const epoch = Date.UTC(1899,11,30);
  const xlDate = v => {
    if (v==null || v==='') return '';
    if (v instanceof Date) return v.toISOString().slice(0,10);
    if (typeof v==='number') return new Date(epoch + Math.round(v*86400000)).toISOString().slice(0,10);
    const s = String(v); const m=s.match(/^(\d{4}-\d{2}-\d{2})/); return m?m[1]:s;
  };
  const sheet = (wb, name)=>{
    if (wb.Sheets[name]) return wb.Sheets[name];
    const lower=name.toLowerCase();
    for (const n of wb.SheetNames) if (n.toLowerCase()===lower) return wb.Sheets[n];
    return null;
  };
  const rows = ws => ws ? XLSX.utils.sheet_to_json(ws,{defval:'',raw:true}) : [];
  const toInt = v => Number.isFinite(+v) ? parseInt(v,10) : 0;

  // keep big arrays on a single line
  function stringifyOneLine(obj, keys){
    const keep = new Set(keys); const tokens=[]; let i=0;
    const json = JSON.stringify(obj,function(k,v){
      if (Array.isArray(v) && keep.has(k)){
        const t = `__ONELINE__${i++}__`; tokens.push([t,'[ '+v.map(x=>JSON.stringify(x)).join(', ')+' ]']); return t;
      }
      return v;
    },2);
    return tokens.reduce((acc,[t,s])=>acc.replace(new RegExp(`"${t}"`,'g'), s), json);
  }
  function stamp(){
    const d=new Date(), p=n=>n<10?'0'+n:n;
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`;
  }

  // -------- main --------
  $('#file').addEventListener('change', async (ev)=>{
    btnJson.disabled = btnBak.disabled = true;
    preview.textContent = '// (no preview)'; statusEl.textContent = '';

    const f = ev.target.files?.[0]; if (!f) return;

    try{
      const buf = await f.arrayBuffer();
      const wb  = XLSX.read(buf, {type:'array', cellDates:false});

      // Sheets (case-insensitive)
      const wsOverview   = sheet(wb,'overview');    // release only
      const wsPlan       = sheet(wb,'plan');        // exec_days, pass_days, pass_target
      const wsPlanned    = sheet(wb,'planned');     // label, planned_executed_pct, planned_pass_pct
      const wsTests      = sheet(wb,'testDaily');   // date, inScope, executedPct, passPct
      const wsDefects    = sheet(wb,'defectsDaily');// date, openDefects
      const wsIssues     = sheet(wb,'issues');      // open Blocker/Critical rows
      const wsKeyDates   = sheet(wb,'keyDates');    // label, date, dateRange, notes

      // overview: only release comes from sheet; inScope is dynamic per day
      const o = rows(wsOverview)[0] || {};
      const overview = { release: o.release ?? '' };

      // plan: verbatim (if present)
      let plan = undefined;
      const rPlan = rows(wsPlan)[0];
      if (rPlan) {
        plan = {
          exec_days:   toInt(rPlan.exec_days),
          pass_days:   toInt(rPlan.pass_days),
          pass_target: toInt(rPlan.pass_target)
        };
      }

      // plannedSeries: verbatim (if present)
      let plannedSeries = undefined;
      const rPlanned = rows(wsPlanned);
      if (rPlanned.length){
        const labels=[], pe=[], pp=[];
        rPlanned.forEach((r,i)=>{
          labels.push(r.label || `Day ${i+1}`);
          pe.push(toInt(r.planned_executed_pct));
          pp.push(toInt(r.planned_pass_pct));
        });
        plannedSeries = { labels, planned_executed_pct: pe, planned_pass_pct: pp };
      }

      // progressDaily (from testDaily)
      const progressDaily = rows(wsTests).map(r=>({
        date: xlDate(r.date),
        inScope: r.inScope!=='' ? toInt(r.inScope) : undefined,
        executedPct: toInt(r.executedPct),
        passPct: toInt(r.passPct)
      }));

      // defectsDaily
      const defectsDaily = rows(wsDefects).map(r=>({
        date: xlDate(r.date),
        openDefects: toInt(r.openDefects)
      }));

      // issues (verbatim)
      const issues = rows(wsIssues).map(r=>({
        key:r.key||'', priority:r.priority||'', summary:r.summary||'',
        reporter:r.reporter||'', team:r.team||'', platform:r.platform||'',
        status:r.status||'', link:r.link||''
      }));

      // keyDates (keep your columns)
      const keyDates = rows(wsKeyDates).map(r=>({
        label: r.label || '',
        date:  r.date ? xlDate(r.date) : '',
        dateRange: r.dateRange || '',
        notes: r.notes || ''
      }));

      // assemble
      const data = {
        asOf: ($asof.value||'').trim(),
        infoUrl: ($info.value||'').trim(),
        statusUrl: ($stUrl.value||'').trim(),
        overview,
        health: { status: ($hStat.value||'auto'), comment: ($hCmt.value||'') },
        ...(plan ? { plan } : {}),
        ...(plannedSeries ? { plannedSeries } : {}),
        progressDaily, defectsDaily, issues, keyDates
      };

      // compact the heavy arrays
      lastText = stringifyOneLine(data, ['labels','planned_executed_pct','planned_pass_pct','progressDaily','defectsDaily']);
      preview.textContent = lastText;
      btnJson.disabled = btnBak.disabled = false;
      statusEl.textContent = 'Parsed âœ“';
    }catch(e){
      console.error(e);
      statusEl.textContent = 'Error: ' + (e?.message||e);
      preview.textContent = '// (no preview)';
    }
  });

  $('#dlJson').addEventListener('click', ()=>{
    if (!lastText) return;
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([lastText],{type:'application/json'}));
    a.download='uat.json'; a.click(); URL.revokeObjectURL(a.href);
  });

  $('#dlBackup').addEventListener('click', ()=>{
    if (!lastText) return;
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([lastText],{type:'application/json'}));
    a.download=`uat-backup_${(new Date()).toISOString().slice(0,16).replace(/[:T]/g,'_')}.json`;
    a.click(); URL.revokeObjectURL(a.href);
  });
})();
</script>
</body>
</html>
