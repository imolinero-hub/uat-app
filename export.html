<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>UAT JSON Export (dynamic only)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- SheetJS v0.20.3 -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --fg:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#ffffff; --pill:#f3f4f6; --accent:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0; font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; color:var(--fg); background:var(--bg)}
    header{padding:20px 16px; border-bottom:1px solid var(--line)}
    h1{margin:0; font-size:20px}
    main{max-width:980px; margin:24px auto; padding:0 16px}

    .card{border:1px solid var(--line); border-radius:12px; background:#fff}
    .row{display:grid; gap:12px}
    @media(min-width:760px){ .row{grid-template-columns:1fr 1fr} }
    label{display:block; font-weight:600; margin:10px 0 6px}
    input[type="text"], input[type="datetime-local"], select{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; outline:none;
    }
    input[type="file"]{padding:8px 0}
    .hint{color:var(--muted); font-size:12px; margin-top:6px}
    .btn{display:inline-flex; gap:8px; align-items:center; padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer}
    .btn.primary{background:linear-gradient(135deg, #3b82f6, #22c55e); color:#fff; border:none}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:6px; background:var(--pill); padding:6px 10px; border-radius:999px; font-size:12px}
    .error{color:#b91c1c; white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .ok{color:#16a34a}
    .preview{white-space:pre; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#0b1220; color:#e5e7eb; padding:16px; border-radius:12px; overflow:auto; border:1px solid var(--line)}
    .section{padding:16px}
    .formats ul{margin:8px 0 0 16px; color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>UAT JSON Export <span class="pill">XLSX (dynamic only)</span></h1>
  </header>

  <main>
    <div class="card section">
      <div class="row">
        <div>
          <label for="file">Choose workbook (.xlsx)</label>
          <input id="file" type="file" accept=".xlsx" />
          <div id="sheetjsState" class="hint">SheetJS: <span id="sheetjsLoaded">checking…</span></div>
        </div>

        <div>
          <label for="asof">As of</label>
          <input id="asof" type="datetime-local" />
          <div class="hint">Will be serialized as <code>YYYY-MM-DD HH:mm</code>.</div>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label for="health">Health</label>
          <select id="health">
            <option value="auto">auto (let app compute)</option>
            <option value="green">green</option>
            <option value="amber">amber</option>
            <option value="red">red</option>
          </select>
          <div class="hint">If not <em>auto</em>, a comment is recommended.</div>
        </div>

        <div>
          <label for="healthComment">Comment (optional; used when Health ≠ auto/green)</label>
          <input id="healthComment" type="text" placeholder="e.g., too many open defects" />
        </div>
      </div>

      <div style="margin-top:16px" class="toolbar">
        <button id="downloadBtn" class="btn primary" disabled>Download <strong>uat-dynamic.json</strong></button>
        <span class="pill">Sheets expected: <code>progressDaily</code>, <code>defectsDaily</code>, <code>issues</code></span>
        <span id="sheetsUsed" class="pill">Sheets used: –</span>
      </div>
      <div id="err" class="error" style="margin-top:10px"></div>
    </div>

    <div class="card section" style="margin-top:16px">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
        <strong>Preview (read-only)</strong>
        <span id="status" class="ok"></span>
      </div>
      <div id="preview" class="preview">// load a workbook to see the JSON here</div>
    </div>

    <div class="card section formats" style="margin-top:16px">
      <strong>Sheet formats</strong>
      <ul>
        <li><code>progressDaily</code>: columns <code>date</code>, <code>inScope</code>, <code>executedPct</code>, <code>passPct</code> (date = Excel date or YYYY-MM-DD; percents 0–100).</li>
        <li><code>defectsDaily</code>: columns <code>date</code>, <code>openDefects</code>.</li>
        <li><code>issues</code>: columns <code>key</code>, <code>priority</code>, <code>summary</code>, <code>reporter</code>, <code>team</code>, <code>platform</code>, <code>status</code>, <code>link</code>.</li>
      </ul>
    </div>
  </main>

<script>
  // ===== utilities =====
  const $ = sel => document.querySelector(sel);
  const preview = $('#preview');
  const errBox  = $('#err');
  const statusEl= $('#status');
  const dlBtn   = $('#downloadBtn');
  const fileInp = $('#file');
  const sheetsUsed = $('#sheetsUsed');

  // Detect SheetJS availability
  $('#sheetjsLoaded').textContent = (window.XLSX ? 'loaded v' + XLSX.version : 'not loaded');

  fileInp.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    await handleFile(file);
  });

  async function handleFile(file){
    errBox.textContent = '';
    statusEl.textContent = '';
    dlBtn.disabled = true;
    preview.textContent = '// parsing…';

    if (!window.XLSX){
      preview.textContent = '';
      errBox.textContent = 'SheetJS (XLSX) is not available. The CDN may be blocked.';
      return;
    }

    try {
      // Read workbook
      const buf = await file.arrayBuffer();
      const wb  = XLSX.read(buf, { type: 'array', cellDates: true, cellNF: false, cellText: false });
    
      // Build JSON from workbook
      const json   = parseWorkbook(wb);
    
      // ---- PRETTY PRINT (multi-line, indented) ----
      const pretty = JSON.stringify(json, null, 2); // << 2 = add line breaks + indentation
      preview.textContent = pretty;
      statusEl.textContent = 'Ready ✓';
      dlBtn.disabled = false;
    
      // Download handler
      dlBtn.onclick = () => {
        const blob = new Blob([pretty + '\n'], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'uat-dynamic.json';
        a.click();
        URL.revokeObjectURL(a.href);
      };
    
    } catch (e) {
      preview.textContent = '';
      errBox.textContent = 'Workbook parse failed: ' + (e && e.message ? e.message : e);
    }
  }
  
  // ===== workbook -> JSON (dynamic only) =====
  function parseWorkbook(wb){
    const used = [];
    const getSheet = name => {
      const ok = wb.SheetNames.includes(name) ? wb.Sheets[name] : null;
      if (ok) used.push(name);
      return ok;
    };
    const rows = sh => sh ? XLSX.utils.sheet_to_json(sh, {defval:'', raw:true}) : [];

    // Inputs
    const asOfRaw = $('#asof')?.value?.trim() || '';
    const healthSel = $('#health')?.value || 'auto';
    const healthComment = $('#healthComment')?.value?.trim() || '';

    // Normalize "asOf"
    let asOf = asOfRaw;
    if (asOfRaw) {
      const d = new Date(asOfRaw);
      if (!Number.isNaN(+d)) {
        const pad = n => String(n).padStart(2,'0');
        asOf = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
    }

    // Sheets
    const pd = rows(getSheet('progressDaily')).map(r => ({
      date: dateString(r.date),
      inScope: Number(r.inScope) || 0,
      executedPct: Number(r.executedPct) || 0,
      passPct: Number(r.passPct) || 0
    }));

    const dd = rows(getSheet('defectsDaily')).map(r => ({
      date: dateString(r.date),
      openDefects: Number(r.openDefects) || 0
    }));

    const iss = rows(getSheet('issues')).map(r => ({
      key: String(r.key || '').trim(),
      priority: String(r.priority || '').trim(),
      summary: String(r.summary || '').trim(),
      reporter: String(r.reporter || '').trim(),
      team: String(r.team || '').trim(),
      platform: String(r.platform || '').trim(),
      status: String(r.status || '').trim(),
      link: String(r.link || '').trim()
    })).filter(i => i.key || i.summary);

    // Health object
    const health = (healthSel === 'auto')
      ? { status:'auto' }
      : (healthSel === 'green'
          ? { status:'green' }
          : { status:healthSel, comment: healthComment });

    // Build dynamic JSON
    const out = { asOf, health, progressDaily: pd, defectsDaily: dd, issues: iss };

    sheetsUsed.textContent = 'Sheets used: ' + (used.length ? used.join(', ') : 'none');
    return out;

    function dateString(v){
      if (!v) return '';
      // Excel serial date
      if (typeof v === 'number') {
        try { return XLSX.SSF.format('yyyy-mm-dd', v); } catch(_) {}
      }
      const d = new Date(v);
      if (!Number.isNaN(+d)) {
        const p = n => String(n).padStart(2,'0');
        return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
      }
      // dd/mm/yyyy → yyyy-mm-dd
      const m = String(v).match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
      return String(v);
    }
  }
</script>
</body>
</html>


