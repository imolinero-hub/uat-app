<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>UAT JSON Export (XLSX • dynamic only)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- SheetJS (fixed version you gave) -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

<style>
  :root{--bg:#0b1220;--card:#0f172a;--border:#1d2a46;--muted:#94a3b8;--text:#e5e7eb;--ok:#22c55e;--brand:#3b82f6}
  html,body{height:100%} body{margin:0;background:linear-gradient(180deg,#0c1220,#0a1222);color:var(--text);
  font:14px/1.45 ui-sans-serif,system-ui,"Segoe UI",Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  h1{margin:0 0 18px;font-weight:700} .badge{font-size:12px;background:#121c33;border:1px solid var(--border);
  color:#cbd5e1;border-radius:10px;padding:2px 10px;margin-left:10px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px 18px 14px;margin:12px 0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  label{display:block;margin:6px 0 6px;color:var(--muted)}
  input,select{width:100%;background:#0b1326;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px 12px}
  .btn{display:inline-flex;align-items:center;gap:10px;border-radius:12px;border:none;padding:10px 14px;
       background:linear-gradient(135deg,var(--brand),var(--ok));color:#fff;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;background:#1f2a44;
        padding:6px 10px;color:#cbd5e1;font-size:12px}
  pre{background:#0a1224;border:1px solid var(--border);border-radius:12px;padding:14px;color:#cfd9ff;white-space:pre-wrap;min-height:120px}
  .error{color:#fda4af}
</style>
</head>
<body>
<div class="wrap">
  <h1>UAT JSON Export <span class="badge">XLSX (dynamic only)</span></h1>

  <!-- 1) Workbook & header -->
  <div class="card">
    <div class="row">
      <div>
        <label>Choose workbook (.xlsx)
          <span id="libStatus" class="chip" style="margin-left:8px">SheetJS: checking…</span>
        </label>
        <input type="file" id="file" accept=".xlsx" />
      </div>
      <div>
        <label>As of</label>
        <input id="asOf" type="datetime-local" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Health</label>
        <select id="health">
          <option value="auto">auto (let app compute)</option>
          <option value="green">green</option>
          <option value="amber">amber</option>
          <option value="red">red</option>
        </select>
      </div>
      <div>
        <label>Daily Status URL</label>
        <input id="statusUrl" placeholder="./daily-status.md" value="./daily-status.md" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Info URL</label>
        <input id="infoUrl" placeholder="./about-uat.md" value="./about-uat.md" />
      </div>
      <div>
        <label>Comment (optional, used when Health ≠ auto/green)</label>
        <input id="comment" placeholder="e.g., too many open defects" />
      </div>
    </div>

    <div style="display:flex;align-items:center;gap:12px;margin-top:12px">
      <button class="btn" id="download" disabled>Download uat-dynamic.json</button>
      <span id="sheetsUsed" class="chip">Sheets used: –</span>
    </div>
  </div>

  <!-- 2) Preview -->
  <div class="card">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
      <span class="chip"><strong>progressDaily</strong></span>
      <span class="chip"><strong>defectsDaily</strong></span>
      <span class="chip"><strong>issues</strong></span>
      <span style="margin-left:auto" class="chip">Preview (read-only)</span>
    </div>
    <pre id="preview">// load a workbook to see the JSON here</pre>
    <div id="err" class="error"></div>
  </div>

  <!-- Formats -->
  <div class="card">
    <h3 style="margin:0 0 10px">Sheet formats</h3>
    <ul>
      <li><b>progressDaily</b>: columns <code>date, inScope, executedPct, passPct</code> (date as Excel date or YYYY-MM-DD; percents 0–100)</li>
      <li><b>defectsDaily</b>: columns <code>date, openDefects</code></li>
      <li><b>issues</b>: columns <code>key, priority, summary, reporter, team, platform, status, link</code></li>
    </ul>
  </div>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const libStatus = $('#libStatus');
  const preview = $('#preview');
  const errBox = $('#err');
  const dlBtn = $('#download');
  const sheetsUsed = $('#sheetsUsed');

  // Init “asOf” default
  $('#asOf').value = new Date().toISOString().slice(0,16);

  // Report SheetJS status
  if (window.XLSX && XLSX.version) {
    libStatus.textContent = `SheetJS: loaded v${XLSX.version}`;
    libStatus.style.color = '#22c55e';
  } else {
    libStatus.textContent = 'SheetJS failed to load';
    libStatus.style.color = '#fca5a5';
  }

  // Helpers
  function excelDateToISO(v){
    if (v === undefined || v === null || v === '') return '';
    // If it's string already (e.g., 2025-10-13), pass through
    if (typeof v === 'string') {
      const t = v.trim();
      if (/^\d{4}-\d{2}-\d{2}/.test(t)) return t.slice(0,10);
    }
    // If SheetJS gave a JS Date:
    if (v instanceof Date) return v.toISOString().slice(0,10);
    // Excel serial
    const d = XLSX.SSF ? XLSX.SSF.parse_date_code(v) : null;
    if (d) {
      const js = new Date(Date.UTC(d.y, d.m - 1, d.d));
      return js.toISOString().slice(0,10);
    }
    // Last resort: string
    return String(v).slice(0,10);
  }

  function number(v){ const n = Number(v); return Number.isFinite(n)? n : 0; }

  function readSheet(ws){
    // SheetJS -> array of objects (header row)
    return XLSX.utils.sheet_to_json(ws, {defval:'', raw:true});
  }

  function parseWorkbook(wb){
    const ws = name => wb.Sheets[name];

    const used = [];
    const out = {
      asOf: new Date($('#asOf').value || Date.now()).toISOString().slice(0,16).replace('T',' '),
      infoUrl: $('#infoUrl').value.trim() || './about-uat.md',
      statusUrl: $('#statusUrl').value.trim() || './daily-status.md',
      health: { status: $('#health').value }
    };
    if (out.health.status !== 'auto' && out.health.status !== 'green'){
      const c = ($('#comment').value||'').trim();
      if (c) out.health.comment = c;
    }

    // progressDaily
    if (ws('progressDaily')) {
      const rows = readSheet(ws('progressDaily')).map(r=>({
        date: excelDateToISO(r.date),
        inScope: number(r.inScope),
        executedPct: number(r.executedPct),
        passPct: number(r.passPct)
      })).filter(r=>r.date);
      out.progressDaily = rows;
      used.push('progressDaily');
    } else {
      out.progressDaily = [];
    }

    // defectsDaily
    if (ws('defectsDaily')) {
      const rows = readSheet(ws('defectsDaily')).map(r=>({
        date: excelDateToISO(r.date),
        openDefects: number(r.openDefects)
      })).filter(r=>r.date);
      out.defectsDaily = rows;
      used.push('defectsDaily');
    } else {
      out.defectsDaily = [];
    }

    // issues
    if (ws('issues')) {
      const rows = readSheet(ws('issues')).map(r=>({
        key: String(r.key||'').trim(),
        priority: String(r.priority||'').trim(),
        summary: String(r.summary||'').trim(),
        reporter: String(r.reporter||'').trim(),
        team: String(r.team||'').trim(),
        platform: String(r.platform||'').trim(),
        status: String(r.status||'').trim(),
        link: String(r.link||'').trim()
      })).filter(r=>r.key || r.summary);
      out.issues = rows;
      used.push('issues');
    } else {
      out.issues = [];
    }

    sheetsUsed.textContent = `Sheets used: ${used.length ? used.join(', ') : '–'}`;
    return out;
  }

  async function handleFile(file){
    errBox.textContent = '';
    preview.textContent = '// parsing…';
    dlBtn.disabled = true;

    if (!window.XLSX) {
      preview.textContent = '';
      errBox.textContent = 'SheetJS (XLSX) is not available. The CDN may be blocked.';
      return;
    }

    try{
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, {type:'array', cellDates:true, cellNF:false, cellText:false});
      const json = parseWorkbook(wb);
      preview.textContent = JSON.stringify(json, null, 2);
      dlBtn.disabled = false;

      dlBtn.onclick = () => {
        const blob = new Blob([JSON.stringify(json, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'uat-dynamic.json';
        a.click();
        URL.revokeObjectURL(a.href);
      };
    }catch(e){
      preview.textContent = '';
      errBox.textContent = 'Workbook parse failed: ' + (e && e.message ? e.message : e);
    }
  }

  $('#file').addEventListener('change', e=>{
    const f = e.target.files && e.target.files[0];
    if (f) handleFile(f);
  });
})();
</script>
</body>
</html>
