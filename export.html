<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UAT JSON Export</title>
  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; background:#0f172a; color:#e2e8f0; padding:20px }
    h1 { font-size:20px; margin-bottom:10px }
    .section { margin-bottom:20px }
    input[type=file] { margin:10px 0 }
    textarea { width:100%; height:320px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre; background:#1e293b; color:#f1f5f9; padding:10px; border-radius:8px; border:1px solid #334155 }
    button { margin:5px; padding:8px 14px; border:none; border-radius:8px; cursor:pointer }
    button:disabled { opacity:.5; cursor:not-allowed }
    .btn-primary { background:#3b82f6; color:#fff }
    .btn-secondary { background:#64748b; color:#fff }
    small { color:#94a3b8 }
  </style>
</head>
<body>
  <h1>UAT JSON Export</h1>

  <div class="section">
    <h3>1) Upload workbook (.xlsx)</h3>
    <input type="file" id="fileInput" accept=".xlsx" />
  </div>

  <div class="section">
    <h3>2) Preview</h3>
    <textarea id="preview" readonly>// (no preview)</textarea>
  </div>

  <div class="section">
    <h3>3) Export</h3>
    <button id="backupBtn" class="btn-secondary" disabled>Download backup</button>
    <button id="jsonBtn" class="btn-primary" disabled>Download uat.json</button>
    <p><small>Upload the generated <code>uat.json</code> to your repo root. Save copies under <code>/backups/</code>.</small></p>
  </div>

  <script>
    let currentJson = null;

    // ---- Helpers -----------------------------------------------------------

    // Find a sheet by one of several candidate names (case-insensitive)
    function pickSheet(wb, candidates) {
      const keys = Object.keys(wb.Sheets);
      for (const cand of candidates) {
        const found = keys.find(k => k.toLowerCase() === cand.toLowerCase());
        if (found) return wb.Sheets[found];
      }
      return null;
    }

    // Read sheet to objects (keep raw so we can detect date serials)
    function sheetToObject(sheet) {
      if (!sheet) return [];
      return XLSX.utils.sheet_to_json(sheet, { defval: "", raw: true });
    }

    // Convert Excel serials or strings to ISO date (YYYY-MM-DD)
    function toISODate(v) {
      if (typeof v === "number") {
        const d = XLSX.SSF.parse_date_code(v);
        if (!d) return String(v);
        const pad = n => String(n).padStart(2,"0");
        return `${d.y}-${pad(d.m)}-${pad(d.d)}`;
      }
      // try to normalize strings that Excel might output (or user typed)
      const s = String(v).trim();
      const dt = new Date(s);
      if (!isNaN(dt.valueOf())) {
        const yyyy = dt.getFullYear();
        const mm = String(dt.getMonth()+1).padStart(2,"0");
        const dd = String(dt.getDate()).padStart(2,"0");
        return `${yyyy}-${mm}-${dd}`;
      }
      return s;
    }

    // Convert Excel serials to ISO datetime (YYYY-MM-DD HH:MM)
    function toISODateTime(v) {
      if (typeof v === "number") {
        const d = XLSX.SSF.parse_date_code(v);
        if (!d) return String(v);
        const pad = n => String(n).padStart(2,"0");
        const date = `${d.y}-${pad(d.m)}-${pad(d.d)}`;
        const time = `${pad(d.H)}:${pad(d.M)}`;
        return `${date} ${time}`;
      }
      const s = String(v).trim();
      const dt = new Date(s);
      if (!isNaN(dt.valueOf())) {
        const yyyy = dt.getFullYear();
        const mm = String(dt.getMonth()+1).padStart(2,"0");
        const dd = String(dt.getDate()).padStart(2,"0");
        const HH = String(dt.getHours()).padStart(2,"0");
        const MM = String(dt.getMinutes()).padStart(2,"0");
        return `${yyyy}-${mm}-${dd} ${HH}:${MM}`;
      }
      return s;
      }

    function downloadFile(content, filename) {
      const blob = new Blob([content], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Keep issues pretty; force compact rows for daily arrays
    function toJsonText(model) {
      const root = {
        overview: model.overview,
        progressDaily: model.progressDaily,
        defectsDaily: model.defectsDaily,
        issues: model.issues
      };

      let pretty = JSON.stringify(root, null, 2);

      const oneLine = (obj, indent = '    ') => {
        const parts = Object.entries(obj).map(([k, v]) => `"${k}": ${JSON.stringify(v)}`);
        return `${indent}{ ${parts.join(', ')} }`;
      };

      const forceOneLineArray = (arrName) => {
        const arr = root[arrName] || [];
        const lines = arr.map(o => oneLine(o)).join(',\n');
        const re = new RegExp(`"${arrName}": \\[([\\s\\S]*?)\\]`);
        pretty = pretty.replace(re, `"${arrName}": [\n${lines}\n  ]`);
      };

      forceOneLineArray('progressDaily');
      forceOneLineArray('defectsDaily');

      return pretty;
    }

    // ---- UI wiring ---------------------------------------------------------

    document.getElementById('fileInput').addEventListener('change', handleFile, false);
    document.getElementById('jsonBtn').addEventListener('click', () => downloadFile(currentJson, 'uat.json'));
    document.getElementById('backupBtn').addEventListener('click', () => {
      const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      downloadFile(currentJson, `uat-backup-${ts}.json`);
    });

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (evt) => {
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, { type: 'array' });

        // Sheets (accept variants; case-insensitive)
        const shOverview     = pickSheet(wb, ['Overview']);
        const shTestsDaily   = pickSheet(wb, ['testsDaily', 'testDaily']);
        const shDefectsDaily = pickSheet(wb, ['DefectsDaily', 'defectsDaily']);
        const shIssues       = pickSheet(wb, ['Issues']);

        // Overview
        const rawOverview = sheetToObject(shOverview)[0] || {};
        const overview = {
          release: rawOverview.release || '',
          lastUpdate: toISODateTime(rawOverview.lastUpdate || ''),
          schedule_start: toISODate(rawOverview.schedule_start || ''),
          schedule_end: toISODate(rawOverview.schedule_end || ''),
          business_days: Number(rawOverview.business_days || 0)
        };

        // testsDaily
        const progressDaily = sheetToObject(shTestsDaily).map(r => ({
          date: toISODate(r.date),
          platform: "ALL",
          team: "ALL",
          inScope: Number(r.inScope || 0),
          executedPct: Number(r.executedPct || 0),
          passPct: Number(r.passPct || 0)
        }));

        // DefectsDaily
        const defectsDaily = sheetToObject(shDefectsDaily).map(r => ({
          date: toISODate(r.date),
          platform: "ALL",
          team: "ALL",
          openDefects: Number(r.openDefects || 0)
        }));

        // Issues
        const issues = sheetToObject(shIssues).map(r => ({
          key: r.key,
          priority: r.priority,
          summary: r.summary,
          reporter: r.reporter,
          team: r.team,
          platform: r.platform,
          status: r.status,
          link: r.link
        }));

        const model = { overview, progressDaily, defectsDaily, issues };
        currentJson = toJsonText(model);

        document.getElementById('preview').value = currentJson;
        document.getElementById('jsonBtn').disabled = false;
        document.getElementById('backupBtn').disabled = false;
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
