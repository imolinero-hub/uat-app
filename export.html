<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>UAT JSON Export</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b1620; --panel:#0f2233; --text:#d9e7ff; --muted:#8fb3d9; --accent:#61dafb; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    h1{font-size:24px;margin:24px 0 12px}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .card{background:var(--panel);border-radius:10px;padding:16px;margin:12px 0}
    .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    input[type=file]{color:var(--text)}
    pre{white-space:pre-wrap;background:#07121a;border-radius:10px;padding:16px;overflow:auto}
    button{border:0;border-radius:8px;padding:10px 14px;color:#001a2c;background:linear-gradient(135deg,#6dd5fa,#2980b9);cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted)}
    .small{font-size:12px}
  </style>
  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>UAT JSON Export</h1>

    <div class="card">
      <h3>1) Upload workbook (.xlsx)</h3>
      <div class="row">
        <input id="file" type="file" accept=".xlsx" />
        <span id="status" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <h3>2) Preview</h3>
      <pre id="preview">// (no preview)</pre>
    </div>

    <div class="card">
      <h3>3) Export</h3>
      <div class="row">
        <button id="dlJson" disabled>Download uat.json</button>
        <button id="dlBackup" disabled>Download backup</button>
      </div>
      <div class="small muted" style="margin-top:8px">
        The preview above is exactly the content that will be downloaded.
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const status = $('#status');
  const preview = $('#preview');
  const btnJson = $('#dlJson');
  const btnBak  = $('#dlBackup');

  let lastRendered = '';  // what you see is what you download

  // ---- helpers -------------------------------------------------------------
  const EPOCH = Date.UTC(1899, 11, 30); // Excel epoch (with 1900 leap bug)
  function xlToISO(v){
    if (v == null || v === '') return '';
    if (v instanceof Date) return v.toISOString().slice(0,10);
    if (typeof v === 'number') {
      const t = EPOCH + Math.round(v * 86400000);
      return new Date(t).toISOString().slice(0,10);
    }
    const s = String(v);
    const m = s.match(/^(\d{4}-\d{2}-\d{2})/);
    return m ? m[1] : s;
  }

  function getSheetCase(wb, wanted){
    if (wb.Sheets[wanted]) return wb.Sheets[wanted];
    const lower = wanted.toLowerCase();
    for (const name of wb.SheetNames){
      if (name.toLowerCase() === lower) return wb.Sheets[name];
    }
    return null;
  }

  function sheetToObjects(ws){
    if (!ws) return [];
    return XLSX.utils.sheet_to_json(ws, {defval:'', raw:true});
  }

  function toInt(v){
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : 0;
  }

  // --- robust one-line array formatter (no regex on JSON) -------------------
  function stringifyWithOneLineArrays(obj, keysOneLine){
    const targets = new Set(keysOneLine);
    const tokens = []; // {t, s}
    let tokenIdx = 0;

    function toOneLine(arr){
      return '[ ' + arr.map(e => JSON.stringify(e)).join(', ') + ' ]';
    }

    // replacer: turn targeted arrays into unique tokens
    const json = JSON.stringify(obj, function (key, value){
      if (Array.isArray(value) && targets.has(key)) {
        const token = `__ONELINE__${tokenIdx++}__`;
        tokens.push({ t: token, s: toOneLine(value) });
        return token; // temporarily emit a string token
      }
      return value;
    }, 2);

    // Replace quoted tokens with the stored one-liners
    let out = json;
    for (const {t, s} of tokens){
      const re = new RegExp(`"${t}"`, 'g');
      out = out.replace(re, s);
    }
    return out;
  }

  function nowStamp(){
    const d = new Date();
    const pad = n => (n<10?'0':'')+n;
    return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'_'+
           pad(d.getHours())+pad(d.getMinutes());
  }

  // ---- main ---------------------------------------------------------------
  $('#file').addEventListener('change', async (ev)=>{
    btnJson.disabled = btnBak.disabled = true;
    preview.textContent = '// (no preview)';
    status.textContent = '';

    const file = ev.target.files && ev.target.files[0];
    if (!file) return;

    try{
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, {type:'array', cellDates:false});

      const wsOverview    = getSheetCase(wb, 'overview');
      const wsTestsDaily  = getSheetCase(wb, 'testsDaily');
      const wsDefDaily    = getSheetCase(wb, 'defectsDaily') || getSheetCase(wb, 'DefectsDaily');
      const wsIssues      = getSheetCase(wb, 'issues');
      const wsTeams       = getSheetCase(wb, 'teams');
      const wsKeyDates    = getSheetCase(wb, 'keyDates');

      const rowsOverview  = sheetToObjects(wsOverview);
      const rowsTests     = sheetToObjects(wsTestsDaily);
      const rowsDef       = sheetToObjects(wsDefDaily);
      const rowsIssues    = sheetToObjects(wsIssues);
      const rowsTeams     = sheetToObjects(wsTeams);
      const rowsKeyDates  = sheetToObjects(wsKeyDates);

      // overview
      const o = rowsOverview[0] || {};
      const overview = {
        release:        o.release ?? '',
        lastUpdate:     (o.lastUpdate ?? '').toString(),
        schedule_start: xlToISO(o.schedule_start),
        schedule_end:   xlToISO(o.schedule_end),
        business_days:  toInt(o.business_days)
      };

      // progressDaily
      const progressDaily = rowsTests.map(r => ({
        date: xlToISO(r.date),
        platform: 'ALL',
        team: 'ALL',
        inScope: toInt(r.inScope),
        executedPct: toInt(r.executedPct),
        passPct: toInt(r.passPct)
      }));

      // defectsDaily (lowercase key is enforced later when assembling)
      const defectsDaily = rowsDef.map(r => ({
        date: xlToISO(r.date),
        platform: 'ALL',
        team: 'ALL',
        openDefects: toInt(r.openDefects)
      }));

      // issues (pretty multiline)
      const issues = rowsIssues.map(r => ({
        key:       r.key       ?? '',
        priority:  r.priority  ?? '',
        summary:   r.summary   ?? '',
        reporter:  r.reporter  ?? '',
        team:      r.team      ?? '',
        platform:  r.platform  ?? '',
        status:    r.status    ?? '',
        link:      r.link      ?? ''
      }));

      // teams + keyDates (flatten to one line later)
      const teams = rowsTeams.map(r => ({
        name:     r.name ?? '',
        platform: r.platform ?? '',
        lead:     r.lead ?? '',
        email:    r.email ?? ''
      }));

      const keyDates = rowsKeyDates.map(r => ({
        label:     r.label ?? '',
        date:      xlToISO(r.date),
        dateRange: r.dateRange ?? '',
        notes:     r.notes ?? ''
      }));

      const data = { overview, progressDaily, defectsDaily, issues, teams, keyDates };

      // Flatten specific arrays to one-line safely
      lastRendered = stringifyWithOneLineArrays(
        data,
        ['progressDaily','defectsDaily','teams','keyDates']
      );

      preview.textContent = lastRendered;
      btnJson.disabled = btnBak.disabled = false;
      status.textContent = 'Parsed âœ“';
    }catch(err){
      console.error(err);
      status.textContent = 'Error: ' + (err?.message || err);
      preview.textContent = '// (no preview)';
    }
  });

  btnJson.addEventListener('click', ()=>{
    if (!lastRendered) return;
    const blob = new Blob([lastRendered], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'uat.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  btnBak.addEventListener('click', ()=>{
    if (!lastRendered) return;
    const blob = new Blob([lastRendered], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `uat-backup_${nowStamp()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });
})();
</script>
</body>
</html>
