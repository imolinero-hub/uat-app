<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>UAT JSON Export (Dynamic only)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f8fafc; font-family: sans-serif; }
    .panel { background: white; border-radius: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,.05); margin: 1rem auto; padding: 1.5rem; max-width: 960px; }
    textarea { width: 100%; font-family: monospace; font-size: 0.9rem; padding: 0.5rem; border: 1px solid #ccc; border-radius: 0.25rem; }
  </style>
</head>
<body class="p-4">

  <h1 class="text-2xl font-bold mb-4">UAT JSON Export <span class="text-sm text-gray-500">(Dynamic only)</span></h1>

  <!-- Panel -->
  <div class="panel">
    <h2 class="text-lg font-semibold mb-3">1) Workbook & header</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block text-sm mb-1">Choose workbook (.xlsx)</label>
        <input type="file" id="file" accept=".xlsx" class="border p-1 w-full">
      </div>
      <div>
        <label class="block text-sm mb-1">As of</label>
        <input type="datetime-local" id="asof" class="border p-1 w-full">
      </div>
      <div>
        <label class="block text-sm mb-1">Health</label>
        <select id="health" class="border p-1 w-full">
          <option value="auto">auto (let app compute)</option>
          <option value="green">green</option>
          <option value="amber">amber</option>
          <option value="red">red</option>
        </select>
      </div>
      <div>
        <label class="block text-sm mb-1">Daily Status URL</label>
        <input type="text" id="statusUrl" value="./daily-status.md" class="border p-1 w-full">
      </div>
      <div>
        <label class="block text-sm mb-1">Info URL</label>
        <input type="text" id="infoUrl" value="./about-uat.md" class="border p-1 w-full">
      </div>
      <div>
        <label class="block text-sm mb-1">Comment (optional, used when Health ≠ auto/green)</label>
        <input type="text" id="comment" class="border p-1 w-full">
      </div>
    </div>
    <button id="downloadBtn" disabled class="px-4 py-2 bg-purple-500 text-white rounded disabled:opacity-50">
      Download <span class="font-mono">uat-dynamic.json</span>
    </button>
  </div>

  <div class="panel">
    <h2 class="text-lg font-semibold mb-3">2) Preview</h2>
    <textarea id="preview" rows="20" readonly placeholder="// load a workbook to see the JSON here"></textarea>
  </div>

  <div class="panel">
    <h2 class="text-lg font-semibold mb-3">Sheet formats</h2>
    <ul class="list-disc ml-6 text-sm">
      <li><span class="font-mono">progressDaily</span>: Columns: <code>date, inScope, executedPct, passPct</code> (Dates: Excel date or YYYY-MM-DD. Percents 0–100)</li>
      <li><span class="font-mono">defectsDaily</span>: Columns: <code>date, openDefects</code></li>
      <li><span class="font-mono">issues</span>: Columns: <code>key, priority, summary, reporter, team, platform, status, link</code></li>
    </ul>
  </div>

  <!-- Resilient SheetJS Loader -->
  <script>
    window.ensureXLSX = new Promise((resolve, reject) => {
      if (window.XLSX) return resolve(window.XLSX);

      function inject(url, onfail) {
        const s = document.createElement('script');
        s.src = url;
        s.async = true;
        s.onload = () => resolve(window.XLSX);
        s.onerror = onfail;
        document.head.appendChild(s);
      }

      inject(
        'https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js',
        () => inject(
          'https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js',
          () => reject(new Error('SheetJS (XLSX) failed to load from both CDNs'))
        )
      );
    });
  </script>

  <script>
    let dynamicJson = {};

    async function handleFile(e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      try {
        await window.ensureXLSX; // wait for SheetJS
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf);

        dynamicJson = {};

        // progressDaily
        const pd = XLSX.utils.sheet_to_json(wb.Sheets['progressDaily'] || {}, { defval: "" });
        if (pd.length) dynamicJson.progressDaily = pd.map(r => ({
          date: r.date, inScope: +r.inScope || 0,
          executedPct: +r.executedPct || 0, passPct: +r.passPct || 0
        }));

        // defectsDaily
        const dd = XLSX.utils.sheet_to_json(wb.Sheets['defectsDaily'] || {}, { defval: "" });
        if (dd.length) dynamicJson.defectsDaily = dd.map(r => ({
          date: r.date, openDefects: +r.openDefects || 0
        }));

        // issues
        const iss = XLSX.utils.sheet_to_json(wb.Sheets['issues'] || {}, { defval: "" });
        if (iss.length) dynamicJson.issues = iss.map(r => ({
          key: r.key, priority: r.priority, summary: r.summary,
          reporter: r.reporter, team: r.team, platform: r.platform,
          status: r.status, link: r.link
        }));

        refreshPreview();
      } catch (err) {
        console.error("Workbook parse failed:", err);
        document.getElementById("preview").value = "// Error reading workbook:\n" + err;
      }
    }

    function refreshPreview() {
      dynamicJson.asOf = document.getElementById("asof").value || new Date().toISOString();
      dynamicJson.health = { status: document.getElementById("health").value, comment: document.getElementById("comment").value || "" };
      dynamicJson.infoUrl = document.getElementById("infoUrl").value;
      dynamicJson.statusUrl = document.getElementById("statusUrl").value;

      const txt = JSON.stringify(dynamicJson, null, 2);
      document.getElementById("preview").value = txt;
      document.getElementById("downloadBtn").disabled = false;
    }

    function downloadJson() {
      const blob = new Blob([JSON.stringify(dynamicJson, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "uat-dynamic.json";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    document.getElementById("file").addEventListener("change", handleFile);
    document.getElementById("downloadBtn").addEventListener("click", downloadJson);
  </script>
</body>
</html>
