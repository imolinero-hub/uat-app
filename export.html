<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>UAT JSON Export (dynamic only)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#475569; --soft:#e2e8f0; --ring:#2563eb;
      --badge:#eef2ff; --good:#16a34a; --warn:#d97706; --bad:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--fg); font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px; margin:32px auto; padding:0 16px}
    h1{font-weight:700; margin:0 0 18px}
    .card{border:1px solid var(--soft); border-radius:12px; background:#fff; margin:14px 0}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    @media (max-width: 900px){ .row{grid-template-columns:1fr} }
    .sec{padding:16px 18px}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input[type="text"], input[type="datetime-local"], select, textarea{
      width:100%; padding:10px 12px; border:1px solid var(--soft); border-radius:10px; outline:0;
      background:#fff; color:var(--fg)
    }
    input:focus, select:focus, textarea:focus{border-color:var(--ring); box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .btn{
      display:inline-flex; align-items:center; gap:.5rem; padding:10px 14px; border-radius:999px; border:0;
      background:linear-gradient(135deg,#6366f1,#22c55e); color:#fff; cursor:pointer; font-weight:600
    }
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .subtle{color:var(--muted); font-size:12px}
    .pill{display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .55rem; border-radius:999px; font-size:12px; background:var(--badge)}
    pre{
      margin:0; padding:14px; border-top:1px solid var(--soft); border-radius:0 0 12px 12px;
      font:12px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; background:#0b1220; color:#dbeafe; overflow:auto
    }
    .error{color:#fff; background:#111827; border-top:1px solid #374151}
    .hint{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .hint .tag{background:#f8fafc; border:1px solid var(--soft); border-radius:999px; padding:.25rem .5rem; font-size:12px}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
  </style>
  <!-- SheetJS (XLSX) – version allowed by your laptop policy -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>UAT JSON Export <span class="pill">dynamic only</span></h1>

    <!-- Controls -->
    <div class="card">
      <div class="sec">
        <div class="topbar">
          <div class="subtle">Sheets expected: <strong>progressDaily</strong>, <strong>defectsDaily</strong>, <strong>issues</strong></div>
          <div id="libState" class="pill">SheetJS: loading…</div>
        </div>
        <div class="row" style="margin-top:12px">
          <div>
            <label>Choose workbook (.xlsx)</label>
            <input id="file" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
            <div class="hint"><span id="sheetsUsed" class="tag">Sheets used: –</span></div>
          </div>
          <div>
            <label>As of</label>
            <!-- user friendly input; we’ll serialize to YYYY-MM-DD HH:mm -->
            <input id="asof" type="datetime-local">
            <div class="subtle">Will be serialized as YYYY-MM-DD HH:mm.</div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Health</label>
            <select id="health">
              <option value="auto" selected>auto (let app compute)</option>
              <option value="green">green</option>
              <option value="amber">amber</option>
              <option value="red">red</option>
            </select>
          </div>
          <div>
            <label>Comment (optional, used when Health ≠ auto/green)</label>
            <input id="comment" type="text" placeholder="e.g., too many open defects">
          </div>
        </div>

        <div style="margin-top:14px; display:flex; gap:10px;">
          <button id="dl" class="btn" disabled>Download <strong>uat-dynamic.json</strong></button>
          <div id="status" class="subtle">Load a workbook to generate JSON…</div>
        </div>
      </div>
      <pre id="preview" class="error">// Error/preview will appear here</pre>
    </div>

    <!-- Sheet format cheatsheet -->
    <div class="card">
      <div class="sec">
        <div class="subtle">Sheet formats</div>
        <ul>
          <li><strong>progressDaily</strong>: columns <code>date</code>, <code>inScope</code>, <code>executedPct</code>, <code>passPct</code> (date = Excel date or YYYY-MM-DD; percents 0–100).</li>
          <li><strong>defectsDaily</strong>: columns <code>date</code>, <code>openDefects</code>.</li>
          <li><strong>issues</strong>: columns <code>key</code>, <code>priority</code>, <code>summary</code>, <code>reporter</code>, <code>team</code>, <code>platform</code>, <code>status</code>, <code>link</code>.</li>
        </ul>
      </div>
    </div>
  </div>

<script>
  // ======== helpers =========================================================
  const $ = id => document.getElementById(id);
  const fileEl = $('file');
  const asofEl = $('asof');
  const healthEl = $('health');
  const commentEl = $('comment');
  const dlBtn = $('dl');
  const preview = $('preview');
  const statusEl = $('status');
  const sheetsUsedEl = $('sheetsUsed');
  const libStateEl = $('libState');

  function toYmd(date){
    // accepts Date | string | number; returns 'YYYY-MM-DD'
    const d = (date instanceof Date) ? date : new Date(date);
    const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function toYmdHmLocal(dtValue){
    if(!dtValue) return '';
    const d = new Date(dtValue);
    const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  const asNumber = v => (v==null || v==='') ? 0 : Number(v);

  // Read a sheet into array of objects, given expected columns
  function readSheet(wb, name){
    const ws = wb.Sheets[name];
    if(!ws) return [];
    const rows = XLSX.utils.sheet_to_json(ws, {defval:null, raw:true});
    return rows;
  }

  function parseWorkbook(wb){
    const used = [];
    // progressDaily
    const pd = readSheet(wb,'progressDaily').map(r => ({
      date: r.date ? toYmd(r.date) : '',
      inScope: asNumber(r.inScope),
      executedPct: asNumber(r.executedPct),
      passPct: asNumber(r.passPct)
    })).filter(r => r.date);
    if (pd.length) used.push('progressDaily');

    // defectsDaily
    const dd = readSheet(wb,'defectsDaily').map(r => ({
      date: r.date ? toYmd(r.date) : '',
      openDefects: asNumber(r.openDefects)
    })).filter(r => r.date);
    if (dd.length) used.push('defectsDaily');

    // issues
    const issues = readSheet(wb,'issues').map(r => ({
      key: r.key ?? '',
      priority: r.priority ?? '',
      summary: r.summary ?? '',
      reporter: r.reporter ?? '',
      team: r.team ?? '',
      platform: r.platform ?? '',
      status: r.status ?? '',
      link: r.link ?? ''
    })).filter(r => r.key || r.summary);
    if (issues.length) used.push('issues');

    sheetsUsedEl.textContent = used.length ? `Sheets used: ${used.join(', ')}` : 'Sheets used: –';

    // assemble JSON rows (header values are applied later via rebuildPreview)
    return { progressDaily: pd, defectsDaily: dd, issues };
  }

  // Pretty print entire JSON, but compact each object inside the specified arrays
  function stringifyWithCompactArrays(obj, arrayKeys=['progressDaily','defectsDaily']){
    // first: pretty for everything
    let pretty = JSON.stringify(obj, null, 2);

    // then: for each array key, collapse inner objects to single lines
    for(const key of arrayKeys){
      // matches: "key": [ ...the array content... ]
      const reBlock = new RegExp(`("${key}"\\s*:\\s*\\[)([\\s\\S]*?)(\\])`, 'm');
      const m = pretty.match(reBlock);
      if(!m) continue;

      // collapse each object within the array block
      const block = m[2];
      // find objects { ... } possibly with trailing commas
      const collapsed = block.replace(/\{\s*[\s\S]*?\s*\}(,?)/g, s => {
        const oneLine = s
          .replace(/\n/g,' ')     // newlines -> spaces
          .replace(/\s{2,}/g,' ') // multiple spaces -> single
          .replace(/\s,\s/g,', ') // tidy commas
          .replace(/\{\s/g,'{ ')
          .replace(/\s\}/g,' }');
        return oneLine;
      });

      pretty = pretty.replace(reBlock, `$1${collapsed}$3`);
    }
    return pretty;
  }

  // ======== NEW: cache + rebuild so header edits reflect in preview/download ==
  let lastRows = null; // { progressDaily:[], defectsDaily:[], issues:[] }

  function rebuildPreview(){
    if(!lastRows) return;

    const out = {
      asOf: toYmdHmLocal(asofEl.value) || toYmd(new Date()),
      health: { status: (healthEl.value || 'auto') }
    };
    if (out.health.status !== 'auto' && out.health.status !== 'green') {
      const c = (commentEl.value || '').trim();
      if (c) out.health.comment = c;
    }
    if (lastRows.progressDaily?.length) out.progressDaily = lastRows.progressDaily;
    if (lastRows.defectsDaily?.length)  out.defectsDaily  = lastRows.defectsDaily;
    if (lastRows.issues?.length)        out.issues       = lastRows.issues;

    const pretty = stringifyWithCompactArrays(out, ['progressDaily','defectsDaily']);
    preview.textContent = pretty;
    statusEl.textContent = 'Ready ✓';
    dlBtn.disabled = false;

    dlBtn.onclick = () => {
      const blob = new Blob([pretty], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'uat-dynamic.json';
      a.click();
      URL.revokeObjectURL(a.href);
    };
  }

  // ======== handlers ========================================================
  fileEl.addEventListener('change', async (ev)=>{
    const file = ev.target.files && ev.target.files[0];
    if(!file){ return; }

    preview.textContent = '// parsing workbook…';
    statusEl.textContent = 'Reading…';
    dlBtn.disabled = true;

    if (!window.XLSX) {
      preview.textContent = '// Error: SheetJS (XLSX) is not available.';
      statusEl.textContent = 'SheetJS not loaded.';
      return;
    }

    try{
      const buf = await file.arrayBuffer();
      const wb  = XLSX.read(buf, { type:'array', cellDates:true, cellNF:false, cellText:false });

      // Parse rows and cache them; header fields applied in rebuildPreview()
      const rows = parseWorkbook(wb);
      lastRows = {
        progressDaily: rows.progressDaily || [],
        defectsDaily:  rows.defectsDaily  || [],
        issues:        rows.issues        || []
      };

      rebuildPreview(); // build preview/download using current header values
    }catch(e){
      preview.textContent = '// Error reading workbook:\n' + (e && e.message ? e.message : e);
      statusEl.textContent = 'Error';
      dlBtn.disabled = true;
    }
  });

  // Rebuild preview whenever header fields change (even after file upload)
  asofEl.addEventListener('input',  rebuildPreview);
  healthEl.addEventListener('change', rebuildPreview);
  commentEl.addEventListener('input', rebuildPreview);

  // initial lib state
  if (window.XLSX) {
    libStateEl.textContent = 'SheetJS: loaded v' + (XLSX.version || '0.20.x');
  } else {
    libStateEl.textContent = 'SheetJS: loading failed';
    libStateEl.style.background = '#fee2e2';
  }

// Auto-seed "asOf" once on load if empty
(function seedAsOf(){
  if (!asofEl) return;
  if (!asofEl.value) {
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    asofEl.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
})();

</script>
</body>
</html>


