<!doctype html>
<html lang="en">
<head>
  <!--
    ┌──────────────────────────────────────────────────────────────────────┐
    │  UAT Dashboard (Leadership View)                                     │
    │  Author: Ildefonso Molinero                                          │
    │  Purpose: simple, always-available UAT status for leadership         │
    │                                                                      │
    │  Tech stack                                                          │
    │   - Tailwind (CDN) for styling                                       │
    │   - Alpine.js for small, reactive app state                          │
    │   - Chart.js (time adapter) for two line charts                      │
    │   - Optional PWA (manifest + service worker)                         │
    │                                                                      │
    │  Key files                                                           │
    │   - index.html  ⇢ UI + Alpine app()                                 │
    │   - uat.json     ⇢ data (overview, schedule, series, issues, etc.)  │
    │   - manifest.webmanifest + icons/…  ⇢ PWA                           │
    │                                                                      │
    │  Editing guide                                                       │
    │   - UI text / labels: search in the HTML sections below              │
    │   - Data schema: see "uat.json" comments inside app().init()         │
    │   - Countdown logic: BizCal helper (modular, easy to tweak)          │
    │   - Charts: drawCharts() – datasets are built from uat.json          │
    │                                                                      │
    │  Notes                                                               │
    │   - No SRI attributes on CDNs to avoid CORS/SRI blocks on GH Pages   │
    │   - Keep functions small, commented, and side-effect aware           │
    └──────────────────────────────────────────────────────────────────────┘
  -->

  <meta charset="utf-8" />
  <title>UAT Dashboard · Leadership View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Basic PWA bits (optional but recommended) -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" sizes="192x192" href="./icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="./icons/icon-512.png">
  <link rel="apple-touch-icon" href="./icons/icon-180.png">
  <meta name="theme-color" content="#0b1220">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Tailwind v2 fallback (kept light for GH Pages reliability) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">
  <!-- Tailwind v3 Play CDN (preferred; overrides v2 if it loads) -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography" crossorigin="anonymous"></script>

  <!-- Alpine.js (small reactive layer) -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" crossorigin="anonymous"></script>
  <!-- Chart.js + time adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3" crossorigin="anonymous"></script>

  <!-- ============================== THEME / STYLE ============================== -->
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --ring:255 255 255/0.1;
      --text:#e5e7eb; --text-weak:#cbd5e1;
      --accent-1:#0ea5e9; --accent-2:#6366f1; --accent-3:#22c55e;
    }
    .theme-light{
      --bg:#f8fafc; --card:#ffffff; --muted:#64748b; --ring:15 23 42/0.08;
      --text:#0f172a; --text-weak:#334155;
    }
    body{
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(59,130,246,.18), transparent 40%),
        radial-gradient(900px 600px at 120% 0%, rgba(34,197,94,.12), transparent 35%),
        var(--bg);
      transition: background-color .2s ease, color .2s ease;
    }
    .pill-lg{
      display:inline-flex; align-items:center;
      padding:.45rem .75rem; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(135deg, rgba(14,165,233,.14), rgba(99,102,241,.14));
      color:var(--text); font-size:.85rem;
    }
    .theme-light .pill-lg{
      border-color: rgba(15,23,42,.14);
      background:linear-gradient(135deg, rgba(14,165,233,.12), rgba(99,102,241,.12));
    }
    .glass{ background:rgba(255,255,255,.03); backdrop-filter:blur(10px); }
    .theme-light .glass{ background:rgba(15,23,42,.04) }
    .card{ background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:1.25rem; }
    .theme-light .card{ border-color: rgba(15,23,42,.06); }
    /* Unified elevated panel surface for Info modal & AI Status */
    .panel{
      background: linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.94));
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 1.25rem;
      box-shadow: 0 20px 55px rgba(0,0,0,.45), 0 1px 0 rgba(255,255,255,.03) inset;
    }
    .theme-light .panel{
      background:#fff; border-color: rgba(15,23,42,.12);
      box-shadow: 0 20px 55px rgba(2,6,23,.15), 0 1px 0 rgba(2,6,23,.06) inset;
    }
    .ring{ box-shadow:0 0 0 1px rgba(var(--ring)); }
    .kpi-label{ font-size:.75rem; letter-spacing:.02em; color:var(--muted); font-weight:600 }
    .kpi-value{ font-size:1.6rem; font-weight:700 }
    .pill{ border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); border-radius:999px; padding:.2rem .6rem; font-size:.72rem }
    .theme-light .pill{ border-color: rgba(15,23,42,.12); background: rgba(15,23,42,.04) }
    .btn{ border:1px solid rgba(255,255,255,.12); border-radius:.9rem; padding:.55rem .9rem; }
    .btn:hover{ background:rgba(255,255,255,.05) }
    .theme-light .btn{ border-color: rgba(15,23,42,.12) }
    .btn-primary{ background-image:linear-gradient(135deg,var(--accent-1) 0%,var(--accent-2) 50%,var(--accent-3) 100%); border:none; color:#fff; }
    .btn-primary:hover{ filter:brightness(.98) }
    .badge{ display:inline-flex; align-items:center; gap:.35rem; font-size:.72rem; padding:.2rem .55rem;
      border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04) }
    .theme-light .badge{ border-color:rgba(15,23,42,.12); background:rgba(15,23,42,.04) }
    .badge-dot{ width:.5rem; height:.5rem; border-radius:999px }
    .timeline-dot{ width:.6rem; height:.6rem; border-radius:999px; background:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.2) }
    .table th, .table td{ padding:.6rem .75rem }
    .table thead th{ font-size:.75rem; color:var(--muted); font-weight:600; border-bottom:1px solid rgba(255,255,255,.08) }
    .theme-light .table thead th{ border-color: rgba(15,23,42,.08) }
    .table tbody tr{ border-bottom:1px solid rgba(255,255,255,.06) }
    .theme-light .table tbody tr{ border-color: rgba(15,23,42,.06) }
    .link{ color:#60a5fa }
    .chart-wrap{ position:relative; height:240px }
    .chart-wrap > canvas{ position:absolute; inset:0; width:100% !important; height:100% !important }
    .countdown-bar{ height:6px; border-radius:999px; background:linear-gradient(90deg,var(--accent-1),var(--accent-2),var(--accent-3)); }
    .toast{ position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#ef4444; color:white; font-size:12px; padding:8px 10px; border-radius:8px }
    .theme-light .toast{ background:#b91c1c }
    .icon-btn{ width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; }
  </style>
</head>

<body x-data="app()" x-init="initTheme()" :class="theme">
<div class="max-w-6xl mx-auto px-4 py-5">

  <!-- ============================== HEADER ============================== -->
  <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-5">
    <div class="flex items-center gap-3">
      <!-- Theme toggle -->
      <button class="icon-btn ring" @click="toggleTheme()" :title="theme==='theme-light' ? 'Switch to dark' : 'Switch to light'"
              :style="'background:linear-gradient(135deg,rgba(14,165,233,.25),rgba(99,102,241,.25))'">
        <template x-if="theme!=='theme-light'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </template>
        <template x-if="theme==='theme-light'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="5" stroke="#111" stroke-width="2"/><path d="M12 1v3m0 16v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M1 12h3m16 0h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12" stroke="#111" stroke-width="2" stroke-linecap="round"/></svg>
        </template>
      </button>

      <div>
        <div class="text-xl font-semibold tracking-tight">UAT Dashboard</div>
        <div class="text-[12px] text-slate-400 flex items-center gap-2">
          <span x-text="raw.overview?.release || 'Release'"></span>
          <span class="opacity-40">•</span>
          Last update: <span class="text-slate-300" x-text="lastUpdate || '—'"></span>
        </div>
      </div>
    </div>

    <div class="flex flex-wrap items-center gap-2">
      <!-- Compact UAT Days badge -->
      <div class="flex items-center">
        <div class="pill-lg" :title="countdown.tooltip">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="mr-2">
            <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
            <path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span class="font-semibold" x-text="countdown.compact"></span>
        </div>
      </div>

      <!-- Platform filter -->
      <select class="glass btn text-sm text-slate-200 theme-light:text-slate-800" x-model="filters.platform" @change="onFilterChange()">
        <option value="">All platforms</option>
        <template x-for="p in platforms" :key="p"><option x-text="p"></option></template>
      </select>

      <!-- Info modal trigger -->
      <button class="btn" @click="openInfo()">
        <span class="inline-flex items-center gap-2">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/><path d="M12 8h.01M11 11h2v5h-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          Info
        </span>
      </button>

      <!-- AI Daily Status -->
      <button class="btn btn-primary" @click="generateAIStatus()">AI Daily Status</button>
    </div>
  </header>

  <!-- ============================== KPIs ============================== -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
    <div class="card p-4"><div class="kpi-label">In Scope</div><div class="kpi-value mt-1" x-text="kpis.inScope"></div></div>
    <div class="card p-4"><div class="kpi-label">Executed %</div><div class="kpi-value mt-1" :class="kpiColor(kpis.executedPct)" x-text="fmtPct(kpis.executedPct)"></div></div>
    <div class="card p-4"><div class="kpi-label">Pass %</div><div class="kpi-value mt-1" :class="kpiColor(kpis.passPct)" x-text="fmtPct(kpis.passPct)"></div></div>
    <div class="card p-4"><div class="kpi-label">Open Defects</div><div class="kpi-value mt-1" x-text="kpis.openDefects"></div></div>
    <div class="card p-4"><div class="kpi-label">Blocker / Critical</div><div class="kpi-value mt-1" :class="kpis.critical>0?'text-rose-400':'text-emerald-400'" x-text="kpis.critical"></div></div>
  </section>

  <!-- ============================== AI Status (panel) ============================== -->
  <section class="panel overflow-hidden mb-6" x-show="aiOpen" x-transition>
    <div class="px-5 py-4 flex items-center justify-between"
         style="background: linear-gradient(180deg, rgba(99,102,241,.12), transparent);">
      <div class="flex items-center gap-2">
        <span class="badge"><span class="badge-dot" style="background:#22c55e"></span> Daily</span>
        <div class="font-semibold">Daily Status (AI-generated)</div>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-xs text-slate-400">For leadership • concise & action-oriented</div>
        <button class="btn icon-btn" aria-label="Close" @click="aiOpen=false" title="Hide">✕</button>
      </div>
    </div>
    <div class="h-px bg-white/10 theme-light:bg-black/10"></div>

    <div class="p-5">
      <div class="prose prose-invert max-w-none text-[15px] leading-6 theme-light:prose">
        <div x-show="!aiStatus" class="text-slate-400">Click <strong>AI Daily Status</strong> to generate today’s summary.</div>
        <div x-show="aiStatus" x-html="aiStatus"></div>
      </div>
      <div class="mt-4 flex flex-wrap gap-2">
        <button class="btn" @click="copyAI()">Copy</button>
        <button class="btn" @click="downloadAI()">Download .md</button>
      </div>
    </div>
  </section>

  <!-- ============================== CHARTS ============================== -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium">Execution Over Time</div>
        <span class="pill">Executed% · Pass%</span>
      </div>
      <div class="chart-wrap"><canvas id="execChart"></canvas></div>
    </div>
    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium">Defect Burndown</div>
        <span class="pill">Open defects</span>
      </div>
      <div class="chart-wrap"><canvas id="defectChart"></canvas></div>
    </div>
  </section>

  <!-- ============================== ISSUES TABLE ============================== -->
  <section class="card p-4 mb-6">
    <div class="flex items-center justify-between mb-2">
      <div class="font-medium">Blocker / Critical Defects</div>
      <div class="text-xs text-slate-400" x-text="`Showing ${issues.length}`"></div>
    </div>
    <div class="overflow-x-auto">
      <table class="table w-full text-sm">
        <thead>
          <tr><th>Key</th><th>Priority</th><th>Summary</th><th>Reporter</th><th>Team</th><th>Platform</th></tr>
        </thead>
        <tbody>
          <template x-for="i in issues" :key="i.key">
            <tr>
              <td><a class="link hover:underline" :href="i.link" target="_blank" x-text="i.key"></a></td>
              <td>
                <span class="badge">
                  <span class="badge-dot" :style="sevDot(i.priority)"></span>
                  <span x-text="i.priority"></span>
                </span>
              </td>
              <td x-text="i.summary"></td>
              <td x-text="i.reporter || i.owner || '—'"></td>
              <td x-text="i.team || '—'"></td>
              <td x-text="i.platform || '—'"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ============================== KEY DATES ============================== -->
  <section class="card p-4 mb-16">
    <div class="font-medium mb-3">Key Dates</div>
    <template x-if="raw.keyDates && raw.keyDates.length">
      <ul class="space-y-3">
        <template x-for="d in raw.keyDates" :key="d.label">
          <li class="flex items-start gap-3">
            <div class="timeline-dot mt-1.5"></div>
            <div class="flex-1">
              <div class="font-medium" x-text="d.label"></div>
              <div class="text-xs text-slate-400" x-text="d.notes || ''"></div>
            </div>
            <div class="text-sm text-slate-300" x-text="d.date || d.dateRange || ''"></div>
          </li>
        </template>
      </ul>
    </template>
    <template x-if="!raw.keyDates || !raw.keyDates.length">
      <div class="text-sm text-slate-400">No key dates loaded.</div>
    </template>
  </section>

  <!-- ============================== INFO MODAL ============================== -->
  <div x-show="infoOpen" x-transition.opacity class="fixed inset-0 bg-black/85 backdrop-blur-[1px] grid place-items-center p-4 z-50">
    <div class="panel max-w-2xl w-full p-5 relative">
      <button class="icon-btn absolute -top-3 -right-3 btn" @click="infoOpen=false" aria-label="Close">✕</button>
      <div class="font-semibold mb-3">UAT Overview</div>
      <div class="prose prose-invert theme-light:prose max-w-none text-[15px]" x-html="infoHtml || '<p class=&quot;text-slate-400&quot;>No info loaded.</p>'"></div>
    </div>
  </div>

</div>

<!-- ============================== APP SCRIPT ============================== -->
<script>
/* --------------------------------------------------------------------------
   BizCal: tiny helper to compute business-day analytics for a date window.
   - Accepts schedule {start, end, timezone, holidays[]}
   - Exposes:
       .businessDays()          -> array of Date(UTC midnight for schedule TZ)
       .isBusiness(d)           -> boolean
       .indexFor(d)             -> number of business days <= d
       .nextBusinessAfter(d)    -> next business day > d
       .formatDay(d)            -> "Oct 13" in schedule TZ
       .todayTZ()               -> today's date at 00:00 in schedule TZ
   -------------------------------------------------------------------------- */
function BizCal(schedule){
  const tz = schedule.timezone || 'Europe/Berlin';
  const holidays = new Set(Array.isArray(schedule.holidays) ? schedule.holidays : []);

  const toTZDate = (dStr) => {
    const parts = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'})
      .formatToParts(new Date(dStr+'T00:00:00'));
    const y = +parts.find(p=>p.type==='year').value;
    const m = +parts.find(p=>p.type==='month').value;
    const d = +parts.find(p=>p.type==='day').value;
    return new Date(Date.UTC(y,m-1,d,0,0,0));
  };
  const todayTZ = () => {
    const now = new Date();
    const parts = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(now);
    const y = +parts.find(p=>p.type==='year').value;
    const m = +parts.find(p=>p.type==='month').value;
    const d = +parts.find(p=>p.type==='day').value;
    return new Date(Date.UTC(y,m-1,d,0,0,0));
  };
  const fmtDay = (d) => new Intl.DateTimeFormat(undefined,{timeZone:tz,month:'short',day:'2-digit'}).format(d);
  const isWeekend = (d) => { const wd = d.getUTCDay(); return wd===0 || wd===6; };
  const isHoliday = (d) => holidays.has(d.toISOString().slice(0,10));
  const isBusiness = (d) => !isWeekend(d) && !isHoliday(d);

  const start = schedule.start ? toTZDate(schedule.start) : null;
  const end   = schedule.end   ? toTZDate(schedule.end)   : null;

  const businessDays = () => {
    const out = [];
    if(!start || !end) return out;
    for(let d = new Date(start); d <= end; d = new Date(d.getTime()+86400000)){
      if(isBusiness(d)) out.push(new Date(d));
    }
    return out;
  };

  const indexFor = (d) => businessDays().filter(x => x <= d).length;

  const nextBusinessAfter = (d) => {
    let n = new Date(d.getTime()+86400000);
    while(!isBusiness(n)) n = new Date(n.getTime()+86400000);
    return n;
  };

  return { businessDays, isBusiness, indexFor, nextBusinessAfter, formatDay:fmtDay, todayTZ, start, end, tz };
}

/* --------------------------------------------------------------------------
   Alpine app(): single source of truth for UI state & actions.
   Structure:
     - State: raw data, KPIs, filters, charts, theme, countdown, etc.
     - Lifecycle: initTheme() -> init()
     - Data loaders & adapters: init(), computeKpis(), filterIssues()
     - Visualization: drawCharts()
     - UX: generateAIStatus(), openInfo(), copyAI(), downloadAI()
     - Countdown: computeCountdown() using BizCal (modular)
   -------------------------------------------------------------------------- */
function app(){
  return {
    /* ---------------------------- STATE ---------------------------------- */
    raw:{ overview:{}, progressDaily:[], defectsDaily:[], issues:[], keyDates:[], schedule:{} },
    kpis:{ inScope:0, executedPct:0, passPct:0, openDefects:0, critical:0 },
    platforms:[], filters:{ platform:'' },
    lastUpdate:'', issues:[],
    execChart:null, defectChart:null,
    aiStatus:'', aiOpen:false,
    theme:'theme-dark',
    countdown:{ title:'UAT Days', label:'—', pct:0, pctShow:false, subtitle:'' },
    infoOpen:false, infoHtml:'',

    /* -------------------------- LIFECYCLE -------------------------------- */
    async init(){
      // Load data from uat.json (no-cache to avoid stale dashboards)
      try{
        const res = await fetch('./uat.json?v=' + Date.now(), { cache:'no-store' });
        if(res.ok){ this.raw = await res.json(); }
        else throw new Error('Failed to fetch uat.json');
      }catch(e){
        console.error('Failed to fetch uat.json', e);
        document.body.insertAdjacentHTML('beforeend','<div class="toast">uat.json could not be loaded</div>');
        return;
      }

      // Initialize high-level view model pieces
      this.lastUpdate = this.raw.overview?.lastUpdate || '';
      this.platforms  = this.getPlatforms();
      this.computeKpis();
      this.drawCharts();
      this.filterIssues();
      this.computeCountdown();   // business-day aware badge
    },

    initTheme(){
      // Restore last theme preference (dark by default)
      const saved = localStorage.getItem('uat-theme');
      this.theme = saved || 'theme-dark';
      document.documentElement.classList.toggle('theme-light', this.theme==='theme-light');
    },

    toggleTheme(){
      // Simple theme toggle persisted in localStorage
      this.theme = (this.theme==='theme-light') ? 'theme-dark' : 'theme-light';
      document.documentElement.classList.toggle('theme-light', this.theme==='theme-light');
      localStorage.setItem('uat-theme', this.theme);
    },

    /* ------------------------ DATA ADAPTERS ------------------------------ */
    getPlatforms(){
      // Produce a unique, sorted list of platforms from issues (fallback to defaults)
      const set = new Set((this.raw.issues||[]).map(i=>i.platform).filter(Boolean));
      return set.size ? [...set].sort() : ['Web','App','BOSS'];
    },

    onFilterChange(){
      // Recompute KPIs + issues when a filter changes (charts remain global)
      this.computeKpis();
      this.filterIssues();
    },

    computeKpis(){
      // Compute KPIs primarily from latest progressDaily + open issues
      const p = this.raw.progressDaily || [];
      if(p.length){
        const last = p[p.length-1];
        this.kpis.inScope     = last.inScope ?? this.raw.overview?.inScope ?? 0;
        this.kpis.executedPct = +last.executedPct || 0;
        this.kpis.passPct     = +last.passPct || 0;
      } else {
        this.kpis.inScope = this.raw.overview?.inScope || 0;
        this.kpis.executedPct = 0; this.kpis.passPct = 0;
      }
      const plat = this.filters.platform;
      const open = (this.raw.issues||[]).filter(i=>{
        const isOpen = !i.status || i.status.toLowerCase() !== 'closed';
        const matches = !plat || i.platform === plat;
        return isOpen && matches;
      });
      this.kpis.openDefects = open.length;
      this.kpis.critical    = open.filter(i=>['Blocker','Critical'].includes(i.priority)).length;
    },

    filterIssues(){
      // Keep only Blocker/Critical, then apply platform filter if set
      const plat = this.filters.platform;
      const keep = new Set(['Blocker','Critical']);
      this.issues = (this.raw.issues || [])
        .filter(i => keep.has((i.priority||'').trim()))
        .filter(i => !plat || i.platform === plat);
    },

    /* -------------------------- CHARTS ----------------------------------- */
    drawCharts(){
      // Early exit if Chart.js isn't available
      if(!window.Chart){ console.error('Chart.js not loaded'); return; }

      // Reusable chart options for a consistent look
      const common = {
        responsive:true, maintainAspectRatio:false, animation:false,
        elements: { line: { borderWidth: 2 }, point: { radius: 3, hitRadius: 6, hoverRadius: 4 } },
        plugins:{ legend:{ position:'bottom', labels:{ color:'#94a3b8' } } }
      };

      // Execution chart (time scale with two series)
      const labels = (this.raw.progressDaily||[]).map(r=>r.date);
      const exec   = (this.raw.progressDaily||[]).map(r=>+r.executedPct||0);
      const pass   = (this.raw.progressDaily||[]).map(r=>+r.passPct||0);

      if(this.execChart){ this.execChart.destroy(); }
      this.execChart = new Chart(document.getElementById('execChart'), {
        type:'line',
        data:{ labels, datasets:[
          {label:'Executed %', data:exec, borderColor:'#60a5fa', backgroundColor:'#60a5fa', tension:.25, spanGaps:true},
          {label:'Pass %',     data:pass, borderColor:'#a78bfa', backgroundColor:'#a78bfa', tension:.25, spanGaps:true}
        ]},
        options:{
          ...common,
          scales:{
            x:{ type:'time', time:{ unit:'day' }, grid:{ color:'rgba(148,163,184,.2)'} },
            y:{ beginAtZero:true, max:100, ticks:{ callback:v=>v+'%' }, grid:{ color:'rgba(148,163,184,.2)'} }
          }
        }
      });

      // Defect burndown (time scale)
      const labelsD = (this.raw.defectsDaily||[]).map(r=>r.date);
      const open    = (this.raw.defectsDaily||[]).map(r=>+r.openDefects||0);

      if(this.defectChart){ this.defectChart.destroy(); }
      this.defectChart = new Chart(document.getElementById('defectChart'), {
        type:'line',
        data:{ labels: labelsD, datasets:[
          {label:'Open defects', data:open, borderColor:'#34d399', backgroundColor:'#34d399', tension:.25, spanGaps:true}
        ]},
        options:{
          ...common,
          scales:{
            x:{ type:'time', time:{ unit:'day' }, grid:{ color:'rgba(148,163,184,.2)'} },
            y:{ beginAtZero:true, grid:{ color:'rgba(148,163,184,.2)'} }
          }
        }
      });
    },

    /* -------------------------- COUNTDOWN (compact) -------------------------- */
    /**
     * Computes the UAT countdown using business days.
     * Populates this.countdown with:
     *  - title:   "UAT Days"
     *  - label:   verbose label used elsewhere (kept for backward compatibility)
     *  - compact: short badge text shown in the header (e.g., "Day 7/19")
     *  - tooltip: full details shown on hover (dates, totals)
     *  - pct:     % of business days completed (for optional progress bars)
     *  - pctShow: whether pct is meaningful for current phase
     *  - subtitle: legacy detail line (still populated)
     */
    computeCountdown(){
      const sch = this.raw.schedule || {};
      const cal = BizCal(sch);              // uses timezone/holidays if provided
      const { start, end } = cal;

      // Missing or invalid schedule
      if(!start || !end){
        this.countdown = {
          title:'UAT Days',
          label:'—',
          compact:'—',
          tooltip:'UAT dates not configured',
          pct:0, pctShow:false,
          subtitle:'(dates missing)'
        };
        return;
      }

      const bizDays = cal.businessDays();
      const total   = bizDays.length;
      const today   = cal.todayTZ();

      const beforeStart = today < start;
      const afterEnd    = today > end;

      // 1) PRE-UAT — show business days until first run day
      if (beforeStart){
        let firstRun = new Date(start);
        while(!cal.isBusiness(firstRun)) firstRun = new Date(firstRun.getTime() + 86400000);

        // Business days from tomorrow until (and including) firstRun
        let daysUntil = 0;
        for (let d = new Date(today.getTime()+86400000); d <= firstRun; d = new Date(d.getTime()+86400000)){
          if (cal.isBusiness(d)) daysUntil++;
        }

        // Calendar days to start for extra clarity in tooltip
        const calDays = Math.ceil((firstRun - today) / 86400000);

        this.countdown = {
          title:   'UAT Days',
          label:   `Starts in ${daysUntil} business day${daysUntil===1?'':'s'}`,
          compact: `Starts in ${daysUntil} biz day${daysUntil===1?'':'s'}`,
          tooltip: `${cal.formatDay(start)} – ${cal.formatDay(end)} · ${total} working days\n${calDays} calendar days to start`,
          pct:     0,
          pctShow: false,
          subtitle:`${cal.formatDay(start)} – ${cal.formatDay(end)} · ${total} working days (${calDays} calendar days to start)`
        };
        return;
      }

      // 2) POST-UAT — completed
      if (afterEnd){
        this.countdown = {
          title:   'UAT Days',
          label:   'Completed',
          compact: 'Completed',
          tooltip: `Ran ${cal.formatDay(start)} – ${cal.formatDay(end)} · ${total} working days`,
          pct:     100,
          pctShow: true,
          subtitle:`${total}/${total} working days · Ran ${cal.formatDay(start)} – ${cal.formatDay(end)}`
        };
        return;
      }

      // 3) INSIDE WINDOW, but NON-BUSINESS DAY — paused
      if (!cal.isBusiness(today)){
        const lastBizIndex = cal.indexFor(new Date(today.getTime() - 86400000)); // how many completed
        const next = cal.nextBusinessAfter(today);
        const pct = Math.max(0, Math.min(100, (lastBizIndex / total) * 100));

        this.countdown = {
          title:   'UAT Days',
          label:   `Paused · resumes ${cal.formatDay(next)}`,
          compact: `Paused · resumes ${cal.formatDay(next)}`,
          tooltip: `Completed day ${lastBizIndex} of ${total}\n${cal.formatDay(start)} – ${cal.formatDay(end)}`,
          pct,
          pctShow: true,
          subtitle:`Completed day ${lastBizIndex} of ${total}`
        };
        return;
      }

      // 4) ACTIVE BUSINESS DAY — show day counter
      const dayIdx = cal.indexFor(today); // 1-based index of current business day
      const pct    = Math.max(0, Math.min(100, (dayIdx / total) * 100));

      this.countdown = {
        title:   'UAT Days',
        label:   `Day ${dayIdx} of ${total}`,
        compact: `Day ${dayIdx}/${total}`,
        tooltip: `${cal.formatDay(start)} – ${cal.formatDay(end)} · ${total} working days`,
        pct,
        pctShow: true,
        subtitle:`${cal.formatDay(start)} – ${cal.formatDay(end)} · ${total} working days`
      };
    },

    /* ----------------------------- INFO ---------------------------------- */
    async openInfo(){
      // Loads a markdown snippet and renders it as lightweight HTML
      this.infoOpen = true;
      this.infoHtml = '<p class="text-slate-400">Loading…</p>';
      const url = this.raw.infoUrl || './about-uat.md';
      try{
        const res = await fetch(url, { cache:'no-store' });
        const md = res.ok ? await res.text() : 'No info available.';
        this.infoHtml = this.mdToHtml(md);
      }catch{
        this.infoHtml = '<p class="text-rose-400">Failed to load info.</p>';
      }
    },

    /* ------------------------------ AI ----------------------------------- */
    generateAIStatus(){
      // Local “AI-style” summary (non-LLM). Replace later with a real endpoint if needed.
      this.aiOpen = true;
      const plat = this.filters.platform || 'All platforms';
      const md = [
        `**Summary (${plat})**`,
        `• Executed ${this.fmtPct(this.kpis.executedPct)}, Pass ${this.fmtPct(this.kpis.passPct)}. Open defects ${this.kpis.openDefects} (${this.kpis.critical} blocker/critical).`,
        `• Execution trending ${this.trendText('exec')} and defects ${this.trendText('def')}.`,
        ``,
        `**Highlights**`,
        `• Most planned scenarios executed; quality trending positively.`,
        `• Key dates on track; no change to Go/No-Go.`,
        ``,
        `**Risks & Blockers**`,
        `${this.issues.length ? '• Active blockers/criticals require attention (see table below).' : '• No Blocker/Critical reported currently.'}`,
        ``,
        `**Next Steps**`,
        `• Close remaining critical defects; re-test impacted flows.`,
        `• Prepare demo materials ahead of Alpha Demo.`,
      ].join('\n');
      this.aiStatus = this.mdToHtml(md);
    },
    copyAI(){ if(this.aiStatus){ navigator.clipboard.writeText(this.htmlToText(this.aiStatus)); } },
    downloadAI(){
      const text = this.aiStatus ? this.htmlToText(this.aiStatus) : '';
      const blob = new Blob([text], {type:'text/markdown'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `UAT_Daily_Status_${(this.lastUpdate||'').replace(/[: ]/g,'_')}.md`;
      a.click(); URL.revokeObjectURL(a.href);
    },

    /* --------------------------- SMALL HELPERS --------------------------- */
    fmtPct(v){ return (v??0).toFixed(0)+'%'; },
    kpiColor(v){ return v>=90 ? 'text-emerald-400' : (v>=70 ? 'text-amber-300' : 'text-rose-400'); },
    sevDot(p){ const c = p==='Blocker' ? '#fb7185' : p==='Critical' ? '#fca5a5' : '#f59e0b'; return `background:${c}`; },
    trendText(kind){
      try{
        if(kind==='exec'){
          const arr = (this.raw.progressDaily||[]).slice(-3).map(r=>+r.executedPct||0);
          if(arr.length<2) return 'steady';
          const d = arr[arr.length-1] - arr[0];
          return d>0 ? 'up' : (d<0 ? 'down' : 'steady');
        }else{
          const arr = (this.raw.defectsDaily||[]).slice(-3).map(r=>+r.openDefects||0);
          if(arr.length<2) return 'steady';
          const d = arr[arr.length-1] - arr[0];
          return d<0 ? 'down' : (d>0 ? 'up' : 'steady');
        }
      }catch{ return '—'; }
    },

    // Minimal markdown → HTML (safe-ish; only bold + bullets, paragraphs)
    mdToHtml(md){
      const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;');
      return esc(md)
        .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
        .replace(/^• /gm,'<li>')
        .replace(/\n{2,}/g,'\n\n')
        .split('\n\n').map(block=>{
          if(block.startsWith('<li>')) return `<ul class="list-disc pl-5 space-y-1">${block.replace(/<li>/g,'<li class="marker:text-slate-400">')}</ul>`;
          return `<p>${block.replace(/\n/g,'<br>')}</p>`;
        }).join('');
    },
    htmlToText(html){ const tmp=document.createElement('div'); tmp.innerHTML=html; return tmp.innerText; }
  }
}
document.addEventListener('alpine:init',()=>{ Alpine.data('app', app) })
</script>

<!-- Optional: service worker registration (keep if you use PWA) 
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('./service-worker.js');
      setInterval(() => reg.update(), 30 * 60 * 1000); // check for updates
    } catch (e) { console.warn('SW failed', e); }
  });
}
</script>
-->

<!-- ===== Footer (discreet author attribution) ===== -->
<footer class="mt-10 pb-6 text-center text-xs text-slate-400 opacity-70 select-none">
  <span>Author: Ildefonso Molinero</span>
</footer>

</body>
</html>
