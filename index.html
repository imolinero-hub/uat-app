<!doctype html>
<html lang="en">
<head>
  <!--
    UAT Dashboard (Leadership View) — modular split
    Author: Ildefonso Molinero
  -->
  <meta charset="utf-8" />
  <title>UAT Dashboard · Leadership View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- PWA (optional) -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" sizes="192x192" href="./icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="./icons/icon-512.png">
  <link rel="apple-touch-icon" href="./icons/icon-180.png">
  <meta name="theme-color" content="#0b1220">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Tailwind v2 (fallback) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  <!-- Tailwind v3 Play (preferred) -->
<!--  <script src="https://cdn.tailwindcss.com?plugins=forms,typography" crossorigin="anonymous"></script>-->

  <!-- Our styles (extracted) -->
  <link rel="stylesheet" href="./styles.css" />

  <!-- Alpine Collapse plugin (required for x-collapse) -->
  <script defer src="https://unpkg.com/@alpinejs/collapse@3.x.x/dist/cdn.min.js" crossorigin="anonymous"></script>
  <!-- Alpine.js (reactive layer) -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" crossorigin="anonymous"></script>
  <!-- Chart.js + time adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3" crossorigin="anonymous"></script>
</head>

<body x-data="app()" x-init="initTheme()" :class="theme">
<div class="max-w-6xl mx-auto px-4 py-5">

  <!-- ============================== HEADER ============================== -->
  <header class="header-v2 mb-3">
    <!-- Row 1: title/sub + RAG -->
    <div class="hdr-row">
      <div class="flex items-center gap-3">
        <!-- Theme toggle (restored) -->
        <button class="icon-btn ring"
                @click="toggleTheme()"
                :title="theme==='theme-light' ? 'Switch to dark' : 'Switch to light'"
                :style="'background:linear-gradient(135deg,rgba(14,165,233,.25),rgba(99,102,241,.25))'">
          <!-- Dark mode icon -->
          <template x-if="theme!=='theme-light'">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"
                    stroke="#fff" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </template>
          <!-- Light mode icon -->
          <template x-if="theme==='theme-light'">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="5" stroke="#111" stroke-width="2"/>
              <path d="M12 1v3m0 16v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M1 12h3m16 0h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"
                    stroke="#111" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </template>
        </button>
  
        <!-- Title + sub -->
        <div>
          <div class="title">UAT Dashboard</div>
          <div class="sub">
            <span class="font-medium" x-text="raw.overview?.release || 'RI-4'"></span>
            <span class="mx-1">•</span>
            Data as of <span x-text="asOf || '-'"></span>
          </div>
        </div>
      </div>

      <!-- Pastel RAG badge (independent of Tailwind utilities) 
      <span class="rag"
            :class="{
              'is-green': (healthBadge.class||'').includes('rag-green'),
              'is-amber': (healthBadge.class||'').includes('rag-amber'),
              'is-red'  : (healthBadge.class||'').includes('rag-red')
            }"
            :title="healthBadge.tooltip"
            x-text="healthBadge.label">
      </span> -->

      <!-- Pastel RAG badge (desktop hover + mobile tap) -->
      <div class="rag-wrap md:relative" x-data="{ open:false }"
           @keydown.escape.window="open=false" @click.outside="open=false">
      
        <span class="rag"
              :class="{
                'is-green': (healthBadge.class||'').includes('rag-green'),
                'is-amber': (healthBadge.class||'').includes('rag-amber'),
                'is-red'  : (healthBadge.class||'').includes('rag-red')
              }"
              :title="healthBadge.tooltip"           <!-- desktop: keep native title -->
              role="button" tabindex="0"             <!-- a11y -->
              @click="open = !open"                  <!-- mobile: toggle popover -->
              @keydown.enter.prevent="open = !open"
              @keydown.space.prevent="open = !open"
        >
          <span x-text="healthBadge.label"></span>
        </span>
      
        <!-- Mobile popover (hidden ≥ md) -->
        <div class="rag-pop md:hidden" x-show="open" x-transition.origin.top.center>
          <div class="rag-pop__arrow"></div>
          <div class="rag-pop__body" x-text="healthBadge.tooltip"></div>
        </div>
      </div>
      
    </div>
  
    <!-- Row 2: pills + primary CTA -->
    <div class="hdr-row" style="margin-top:8px;">
      <button class="pill" :title="countdown.tooltip">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="opacity-80">
          <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
          <path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span class="font-medium" x-text="countdown.compact"></span>
      </button>
  
      <button class="pill" @click="openInfo()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="opacity-80">
          <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
          <path d="M12 8h.01M11 11h2v5h-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span class="font-medium">Info</span>
      </button>

      <!-- desktop-only Scope chip -->
      <span class="mx-1 hidden md:inline">•</span>
      <span class="scope-inline hidden md:inline-flex items-center gap-1">
        Scope: <strong x-text="kpis.inScope"></strong>
        <span class="suffix">scenarios</span>
      </span>
      
      <button class="cta" style="margin-left:auto" @click="openDaily()">Daily Status</button>
    </div>
  
    <!-- Subtle divider -->
    <div class="divider"></div>
  </header>

  <!-- ============================== KPIs ============================== 
  <section class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-6">
    <div class="card p-4"><div class="kpi-label">In Scope</div><div class="kpi-value mt-1" x-text="kpis.inScope"></div></div>
    <div class="card p-4"><div class="kpi-label">Executed %</div><div class="kpi-value mt-1 font-bold" :class="(kpis.execColorClass||kpiColor(kpis.executedPct))" x-text="fmtPct(kpis.executedPct)"></div><div class="text-xs text-slate-400 mt-1 flex items-center gap-2">Planned today:<span class="kpi-planned" x-text="fmtPct(kpis.plannedExecutedPct||0)"></span><span class="kpi-delta" x-text="kpis.execDelta>=0 ? ('▲ '+kpis.execDelta+'pp') : ('▼ '+Math.abs(kpis.execDelta)+'pp')"></span></div></div>
    <div class="card p-4"><div class="kpi-label">Pass %</div><div class="kpi-value mt-1 font-bold" :class="(kpis.passColorClass||kpiColor(kpis.passPct))" x-text="fmtPct(kpis.passPct)"></div><div class="text-xs text-slate-400 mt-1 flex items-center gap-2">Planned today:<span class="kpi-planned" x-text="fmtPct(kpis.plannedPassPct||0)"></span><span class="kpi-delta" x-text="kpis.passDelta>=0 ? ('▲ '+kpis.passDelta+'pp') : ('▼ '+Math.abs(kpis.passDelta)+'pp')"></span></div></div>
    <div class="card p-4"><div class="kpi-label">Open Defects</div><div class="kpi-value mt-1" x-text="kpis.openDefects"></div></div>
    <div class="card p-4 col-span-2 md:col-span-1"><div class="kpi-label">Blocker / Critical</div><div class="kpi-value mt-1" :class="kpis.critical>5 ? 'text-rose-400' : (kpis.critical>=3 ? 'text-amber-300' : '')" x-text="kpis.critical"></div></div>
  </section>-->

  <!-- ============================== KPIs ============================== -->
  <section class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
    <!-- Executed % -->
    <div class="card p-4">
      <div class="kpi-label">Executed %</div>
      <div class="kpi-value mt-1 font-bold"
           :class="(kpis.execColorClass||kpiColor(kpis.executedPct))"
           x-text="fmtPct(kpis.executedPct)"></div>
      <div class="text-xs text-slate-400 mt-1 flex items-center gap-2">
        Planned today:
        <span class="kpi-planned" x-text="fmtPct(kpis.plannedExecutedPct||0)"></span>
        <span class="kpi-delta" x-text="kpis.execDelta>=0 ? ('▲ '+kpis.execDelta+'pp') : ('▼ '+Math.abs(kpis.execDelta)+'pp')"></span>
      </div>
    </div>
  
    <!-- Pass % -->
    <div class="card p-4">
      <div class="kpi-label">Pass %</div>
      <div class="kpi-value mt-1 font-bold"
           :class="(kpis.passColorClass||kpiColor(kpis.passPct))"
           x-text="fmtPct(kpis.passPct)"></div>
      <div class="text-xs text-slate-400 mt-1 flex items-center gap-2">
        Planned today:
        <span class="kpi-planned" x-text="fmtPct(kpis.plannedPassPct||0)"></span>
        <span class="kpi-delta" x-text="kpis.passDelta>=0 ? ('▲ '+kpis.passDelta+'pp') : ('▼ '+Math.abs(kpis.passDelta)+'pp')"></span>
      </div>
    </div>
  
    <!-- Open defects -->
    <div class="card p-4">
      <div class="kpi-label">Open Defects</div>
      <div class="kpi-value mt-1" x-text="kpis.openDefects"></div>
    </div>
  
    <!-- Blocker / Critical -->
    <div class="card p-4">
      <div class="kpi-label">Blocker / Critical</div>
      <div class="kpi-value mt-1"
           :class="kpis.critical>5 ? 'text-rose-400' : (kpis.critical>=3 ? 'text-amber-300' : '')"
           x-text="kpis.critical"></div>
    </div>
   </section>
  
  <!-- Mobile-only slim pill row, centered and narrower than cards -->
  <div class="md:hidden flex justify-center mb-6">
    <div class="pill-slim">Current scope: <b x-text="kpis.inScope"></b> test scenarios</div>
  </div>

  
  <!-- ================= Daily Status Panel ================= -->
  <section class="panel overflow-hidden mb-6" x-show="dailyOpen" x-transition>
    <div class="px-5 py-4 flex items-center justify-between"
         style="background: linear-gradient(180deg, rgba(99,102,241,.12), transparent);">
      <div class="flex items-center gap-2">
        <span class="badge"><span class="badge-dot" style="background:#22c55e"></span> Daily</span>
        <div class="font-semibold">Daily Status</div>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-xs text-slate-400">For leadership • concise &amp; action-oriented</div>
        <button class="btn icon-btn" aria-label="Close" @click="dailyOpen=false" title="Hide">✕</button>
      </div>
    </div>
  
    <div class="h-px bg-white/10 theme-light:bg-black/10"></div>
  
    <div class="p-5">
      <!-- When no status is generated -->
      <div x-show="!dailyHtml" class="text-slate-400 text-center">
        Click <strong>Daily Status</strong> to generate today’s summary.
      </div>
  
      <!-- Rendered status (from app.js) -->
      <div x-show="dailyHtml" x-html="dailyHtml"></div>
  
      <div class="mt-4 flex flex-wrap gap-2" x-show="dailyHtml">
        <button class="btn" @click="copyDaily()">Copy</button>
        <button class="btn" @click="downloadDaily()">Download .md</button>
      </div>
    </div>
  </section>

  
  <!-- ============================== CHARTS ============================== -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium">Execution Over Time</div>
        <span class="pill">Executed% · Pass%</span>
      </div>
      <div class="chart-wrap"><canvas id="execChart"></canvas></div>
    </div>
    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium">Defect Burndown</div>
        <span class="pill">Open defects</span>
      </div>
      <div class="chart-wrap"><canvas id="defectChart"></canvas></div>
    </div>
  </section>

  <!-- ====================== Blocker / Critical Defects ====================== -->
  <section class="mt-6">
    <div class="flex items-center justify-between mb-2">
      <h2 class="section-title"><b>Blocker / Critical Defects</b></h2>
      <div class="text-xs text-slate-400 dark:text-slate-500">
        Showing <span x-text="issues.length"></span>
      </div>
    </div>
  
    <!-- Empty state -->
    <template x-if="!issues.length">
      <div class="card p-4 text-sm text-slate-500 dark:text-slate-400">
        No blocker/critical defects.
      </div>
    </template>
  
    <!-- Cards -->
    <div class="grid gap-3">
      <template x-for="it in issues" :key="it.key">
        <!-- Make the whole card the link -->
        <a
          class="card p-4 flex gap-3 items-start hover:shadow-md transition-shadow"
          :href="it.link"
          target="_blank"
          rel="noopener"
        >
          <!-- Left rail: ID and priority chip -->
          <div class="issue-rail">
            <span class="issue-id">
              <span x-text="it.key"></span>
            </span>
    
            <!-- Priority chip -->
            <span
              class="issue-chip inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full"
              :style="it.priority==='Critical'
                        ? 'background:#fef2f2;color:#e11d48;border:1px solid #fee2e2'
                        : 'background:#fffbeb;color:#b45309;border:1px solid #fef3c7'"
            >
              <span
                class="inline-block w-2 h-2 rounded-full"
                :style="it.priority==='Critical' ? 'background:#fb7185' : 'background:#f59e0b'"
              ></span>
              <span x-text="it.priority"></span>
            </span>
          </div>
    
          <!-- Main column -->
          <div class="flex-1 min-w-0">
            <div class="issue-title font-semibold leading-snug"
                 x-text="it.summary"></div>
    
            <div class="issue-meta mt-2 text-xs text-slate-500 dark:text-slate-400 flex flex-wrap gap-x-4 gap-y-1">
              <div><span class="text-slate-400">Team:</span> <span x-text="it.team || '—'"></span></div>
              <div><span class="text-slate-400">Platform:</span> <span x-text="it.platform || '—'"></span></div>
              <div><span class="text-slate-400">Status:</span> <span x-text="it.status || '—'"></span></div>
            </div>
          </div>
    
          <!-- Chevron -->
          <svg width="16" height="16" viewBox="0 0 24 24" class="opacity-40 shrink-0">
            <path d="M9 6l6 6-6 6" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      </template>
    </div>
  </section>

  
  <!-- ============================== KEY DATES ============================== -->
  <section class="card p-4 mb-16" x-data="keyDatesAccordion()" x-init="init(raw.keyDates)" x-effect="init(raw.keyDates)">
    <div class="font-medium mb-3">Key Dates</div>
  
    <!-- Mobile: preview (collapsed by default) -->
    <div class="md:hidden">
      <!-- If we have an upcoming date, show the preview row -->
      <template x-if="next">
        <button class="w-full text-left card p-4 flex items-center justify-between gap-3"
                @click="open = !open" :aria-expanded="open">
          <div class="min-w-0">
            <div class="text-xs text-slate-400">Next</div>
            <div class="font-medium truncate" x-text="next.label"></div>
            <div class="text-xs text-slate-400 truncate" x-text="next.when"></div>
          </div>
  
          <div class="flex items-center gap-3 shrink-0">
            <span class="pill" x-text="next.daysUntil >= 0 ? (next.daysUntil + ' days') : 'started'"></span>
            <!-- chevron -->
            <svg :class="open ? 'rotate-180' : ''"
                 class="transition-transform" width="18" height="18" viewBox="0 0 24 24">
              <path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </button>
      </template>
  
      <!-- If no dates at all -->
      <template x-if="!items.length">
        <div class="text-sm text-slate-400">No key dates loaded.</div>
      </template>
  
      <!-- Expanded list -->
      <div class="mt-3 space-y-3" x-show="open" x-collapse>
        <template x-for="d in items" :key="d.label">
          <div class="card p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-medium" x-text="d.label"></div>
                <div class="text-xs text-slate-400" x-text="d.notes || ''"></div>
              </div>
              <span class="pill" x-text="d.date || d.dateRange || ''"></span>
            </div>
          </div>
        </template>
      </div>
    </div>
  
    <!-- Desktop timeline (unchanged) -->
    <div class="hidden md:block">
      <template x-if="raw.keyDates && raw.keyDates.length">
        <ul class="space-y-3">
          <template x-for="d in raw.keyDates" :key="d.label">
            <li class="flex items-start gap-3">
              <div class="timeline-dot mt-1.5"></div>
              <div class="flex-1">
                <div class="font-medium" x-text="d.label"></div>
                <div class="text-xs text-slate-400" x-text="d.notes || ''"></div>
              </div>
              <div class="text-sm text-slate-300" x-text="d.date || d.dateRange || ''"></div>
            </li>
          </template>
        </ul>
      </template>
      <template x-if="!raw.keyDates || !raw.keyDates.length">
        <div class="text-sm text-slate-400">No key dates loaded.</div>
      </template>
    </div>
  </section>


  <!-- ============================== INFO MODAL ============================== -->
  <div x-show="infoOpen" x-transition.opacity
       @keydown.escape.window="closeInfo()">
    <div class="modal-backdrop" @click="closeInfo()"></div>
    <div class="modal-wrap" aria-modal="true" role="dialog" aria-labelledby="info-title">
      <div class="modal-panel" tabindex="-1" x-ref="infoDialog">
        <div class="modal-header flex items-center justify-between">
          <h2 id="info-title" class="text-base font-semibold">Information</h2>
          <button class="px-2 py-1 rounded hover:bg-slate-800/10"
                  @click="closeInfo()" aria-label="Close">✕</button>
        </div>
        <div class="modal-body prose prose-invert max-w-none"
             x-html="infoHtml">
          <!-- content injected by JS -->
        </div>
        <div class="modal-footer flex justify-end gap-2">
          <button class="px-3 py-2 rounded bg-slate-600/10 hover:bg-slate-600/20"
                  @click="closeInfo()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Daily Status Modal -->
  <div x-show="dailyOpen" x-transition.opacity @keydown.escape.window="closeDaily()">
    <div class="modal-backdrop" @click="closeDaily()"></div>

    <div class="modal-wrap" aria-modal="true" role="dialog" aria-labelledby="daily-title">
      <div class="modal-panel" tabindex="-1" x-ref="dailyDialog">
        <div class="modal-header flex items-center justify-between">
          <h2 id="daily-title" class="text-base font-semibold">Daily Status</h2>
          <div class="flex items-center gap-2">
            <button class="px-2 py-1 rounded hover:bg-slate-800/10" @click="copyDaily()" title="Copy">Copy</button>
            <button class="px-2 py-1 rounded hover:bg-slate-800/10" @click="downloadDaily()" title="Download">Download</button>
            <button class="px-2 py-1 rounded hover:bg-slate-800/10" @click="closeDaily()" aria-label="Close">✕</button>
          </div>
        </div>

        <div class="modal-body prose prose-invert max-w-none" x-html="dailyHtml">
          <!-- content injected by JS -->
        </div>

        <div class="modal-footer flex justify-end gap-2">
          <button class="px-3 py-2 rounded bg-slate-600/10 hover:bg-slate-600/20"
                  @click="closeDaily()">Close</button>
        </div>
      </div>
    </div>
  </div>
  
</div>

<!-- Our app script (extracted) -->
<script src="./app.js"></script>

<script>
  function keyDatesAccordion() {
    return {
      open: false,
      items: [],
      next: null,
      init(list) {
        this.items = Array.isArray(list) ? list : [];
        this.next = this.computeNext(this.items);
      },
      computeNext(list) {
        if (!list || !list.length) return null;
        const todayMs = new Date(); todayMs.setHours(0,0,0,0);

        const parseStart = (d) => {
          if (d.date) return new Date(d.date);
          if (!d.dateRange) return null;
          const parts = d.dateRange.split(/to|→/i).map(s => s.trim());
          if (!parts[0]) return null;
          return new Date(parts[0]);
        };

        let best = null;
        for (const d of list) {
          const start = parseStart(d);
          if (!start || isNaN(+start)) continue;
          const startMs = new Date(start.getFullYear(), start.getMonth(), start.getDate());
          if (startMs >= todayMs && (!best || startMs < best.startMs)) {
            best = {
              label: d.label,
              when: d.date || d.dateRange || '',
              startMs
            };
          }
        }
        if (!best) return null;

        const daysUntil = Math.ceil((best.startMs - todayMs) / 86400000);
        return { ...best, daysUntil };
      }
    }
  }
</script>

<!-- Footer -->
<footer class="mt-10 pb-6 text-center text-xs text-slate-400 opacity-70 select-none">
  <span>Author: Ildefonso Molinero</span>
</footer>

</body>
</html>
