<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>UAT Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- PWA (paths relative to /uat-app/) -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" sizes="192x192" href="./icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="./icons/icon-512.png">
  <link rel="apple-touch-icon" href="./icons/icon-180.png">
  <meta name="theme-color" content="#111827">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Chart.js + time adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

  <style>
    .card { @apply bg-white rounded-2xl shadow p-4; }
    .badge { @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium; }
    .badge-uat { @apply bg-indigo-50 text-indigo-700; }
    .kpi { @apply text-sm text-gray-500 font-semibold; } /* bold headers */
    .kpi-value { @apply text-2xl font-semibold text-gray-900; }
    .chart-wrap { position: relative; height: 260px; }
    .chart-wrap > canvas { position:absolute; inset:0; width:100% !important; height:100% !important; display:block; }
    .img-wrap { @apply rounded-xl border; overflow: hidden; }
    .img-note { @apply text-xs text-gray-500 mt-2; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="max-w-6xl mx-auto p-4" x-data="app()">
  <!-- Header -->
  <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
    <div>
      <h1 class="text-2xl font-bold tracking-tight">UAT Dashboard</h1>
      <div class="mt-1 flex gap-2 items-center">
        <span class="badge badge-uat">UAT</span>
        <span class="text-xs text-gray-500">Last update: <span x-text="lastUpdate || '—'"></span></span>
        <span class="text-xs text-gray-400">v1.4 (hybrid charts + fixes)</span>
      </div>
    </div>
    <div class="flex flex-wrap gap-2">
      <!-- Platforms/Channels -->
      <select class="card py-2" x-model="filters.platform" @change="applyFilters()">
        <option value="">All platforms</option>
        <template x-for="p in platforms" :key="p"><option x-text="p"></option></template>
      </select>
      <!-- Teams -->
      <select class="card py-2" x-model="filters.team" @change="applyFilters()">
        <option value="">All teams</option>
        <template x-for="t in teams" :key="t"><option x-text="t"></option></template>
      </select>

      <!-- Toggle image/live -->
      <button class="card hover:bg-slate-100" @click="useImageCharts = !useImageCharts">
        <span x-text="useImageCharts ? 'Show Live Charts' : 'Show Images'"></span>
      </button>

      <button class="card hover:bg-slate-100" @click="generateReport()">Generate Status (MD)</button>
    </div>
  </header>

  <!-- KPIs -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 mb-4">
    <div class="card"><div class="kpi">In Scope</div><div class="kpi-value" x-text="kpis.inScope"></div></div>
    <div class="card"><div class="kpi">Executed %</div><div class="kpi-value" x-text="fmtPct(kpis.executedPct)"></div></div>
    <div class="card"><div class="kpi">Pass %</div><div class="kpi-value" x-text="fmtPct(kpis.passPct)"></div></div>
    <div class="card"><div class="kpi">Open Defects</div><div class="kpi-value" x-text="kpis.openDefects"></div></div>
    <div class="card">
      <div class="kpi">Blocker / Critical</div>
      <div class="kpi-value" :class="kpis.critical > 0 ? 'text-red-600' : 'text-emerald-600'" x-text="kpis.critical"></div>
    </div>
  </section>

  <!-- Charts (hybrid: live with fallback images) -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4" x-data @chart-error.window="useImageCharts = true">
    <!-- Execution -->
    <div class="card">
      <div class="mb-2 font-medium flex items-center justify-between">
        <span>Execution Over Time</span>
        <span class="text-xs text-gray-500" x-show="useImageCharts">(image)</span>
      </div>

      <template x-if="!useImageCharts">
        <div class="chart-wrap"><canvas id="execChart"></canvas></div>
      </template>

      <template x-if="useImageCharts">
        <div class="img-wrap">
          <img src="./charts/execution.png" alt="Execution Over Time chart" class="w-full" loading="lazy"
               onerror="this.replaceWith(Object.assign(document.createElement('div'),{className:'p-6 text-sm text-gray-500',textContent:'Chart image not found. Upload /charts/execution.png'}));">
        </div>
      </template>

      <div class="img-note">Source: Excel snapshot</div>
    </div>

    <!-- Defects -->
    <div class="card">
      <div class="mb-2 font-medium flex items-center justify-between">
        <span>Defect Burndown</span>
        <span class="text-xs text-gray-500" x-show="useImageCharts">(image)</span>
      </div>

      <template x-if="!useImageCharts">
        <div class="chart-wrap"><canvas id="defectChart"></canvas></div>
      </template>

      <template x-if="useImageCharts">
        <div class="img-wrap">
          <img src="./charts/defects.png" alt="Defect Burndown chart" class="w-full" loading="lazy"
               onerror="this.replaceWith(Object.assign(document.createElement('div'),{className:'p-6 text-sm text-gray-500',textContent:'Chart image not found. Upload /charts/defects.png'}));">
        </div>
      </template>

      <div class="img-note">Source: Excel snapshot</div>
    </div>
  </section>

  <!-- Top Open Issues (Blocker/Critical only) -->
  <section class="card mb-4">
    <div class="flex items-center justify-between mb-2">
      <div class="font-medium">Top Open Issues</div>
      <div class="text-xs text-gray-500" x-text="`Showing ${issues.length} of ${issuesTotal} (Blocker/Critical)`"></div>
    </div>
    <div class="overflow-auto">
      <table class="min-w-full text-sm">
        <thead class="text-left text-gray-500">
          <tr>
            <th class="py-2 pr-4">Key</th>
            <th class="py-2 pr-4">Priority</th>
            <th class="py-2 pr-4">Summary</th>
            <th class="py-2 pr-4">Owner</th>
            <th class="py-2 pr-4">Team</th>
            <th class="py-2 pr-4">Platform</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="i in issues" :key="i.key">
            <tr class="border-t">
              <td class="py-2 pr-4"><a :href="i.link" target="_blank" class="text-indigo-600 hover:underline" x-text="i.key"></a></td>
              <td class="py-2 pr-4">
                <span class="badge" :class="sevClass(i.priority || i.severity)" x-text="i.priority || i.severity"></span>
              </td>
              <td class="py-2 pr-4" x-text="i.summary"></td>
              <td class="py-2 pr-4" x-text="i.owner || '—'"></td>
              <td class="py-2 pr-4" x-text="i.team || '—'"></td>
              <td class="py-2 pr-4" x-text="i.platform || i.country || '—'"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Teams & Key Dates -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-20">
    <div class="card">
      <div class="font-medium mb-2">Teams & Contacts</div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <template x-for="t in raw.teams" :key="t.name">
          <div class="border rounded-xl p-3">
            <div class="font-semibold" x-text="t.name"></div>
            <div class="text-xs text-gray-500" x-text="t.platform || t.country || ''"></div>
            <div class="mt-1 text-sm"><span class="text-gray-500">Lead: </span><span x-text="t.lead"></span></div>
            <div class="text-sm"><span class="text-gray-500">Email: </span>
              <a :href="`mailto:${t.email}`" class="text-indigo-600 hover:underline" x-text="t.email"></a>
            </div>
          </div>
        </template>
      </div>
    </div>

    <div class="card">
      <div class="font-medium mb-2">Key Dates</div>

      <!-- Empty state -->
      <template x-if="!raw.keyDates || !raw.keyDates.length">
        <div class="text-sm text-gray-500 p-3">No key dates loaded. Check <code>uat.json</code>.</div>
      </template>

      <!-- List -->
      <template x-if="raw.keyDates && raw.keyDates.length">
        <ul class="space-y-2">
          <template x-for="d in raw.keyDates" :key="d.label">
            <li class="flex items-center justify-between">
              <div>
                <div class="font-medium" x-text="d.label"></div>
                <div class="text-xs text-gray-500" x-text="d.notes || ''"></div>
              </div>
              <div class="text-sm" x-text="d.date || d.dateRange || ''"></div>
            </li>
          </template>
        </ul>
      </template>
    </div>
  </section>

  <!-- Modal: Report -->
  <div x-show="reportOpen" style="display:none" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="font-semibold">Generated Status (Markdown)</div>
        <button class="text-sm text-gray-500 hover:text-gray-700" @click="reportOpen=false">Close</button>
      </div>
      <textarea class="w-full h-64 border rounded-xl p-3 text-sm font-mono" x-text="reportMD"></textarea>
      <div class="mt-3 flex gap-2">
        <button class="card hover:bg-slate-100" @click="copyReport()">Copy</button>
        <button class="card hover:bg-slate-100" @click="downloadReport()">Download .md</button>
      </div>
    </div>
  </div>
</div>

<script>
function app(){
  return {
    raw: { overview:{}, progressDaily:[], defectsDaily:[], issues:[], teams:[], keyDates:[] },
    filtered: { progressDaily:[], defectsDaily:[] },
    issues: [],
    issuesTotal: 0,
    platforms: [],
    teams: [],
    filters: { platform:'', team:'' },
    kpis: { inScope:0, executedPct:0, passPct:0, openDefects:0, critical:0 },
    lastUpdate: '',
    reportOpen:false,
    reportMD:'',
    // hybrid chart bits
    useImageCharts:false,
    execChart:null, defectChart:null,
    // guard against re-entrancy
    isUpdatingCharts:false,
    pendingChartUpdate:null,

    async init(){
      try {
        const res = await fetch('./uat.json?v=' + Date.now(), { cache:'no-store' });
        if (res.ok) this.raw = await res.json();
      } catch(e){ console.error('Failed to load uat.json', e); }

      this.lastUpdate = this.raw.overview?.lastUpdate || '';
      this.buildFilters(); 
      this.applyFilters();
      this.drawCharts();   // will no-op if images selected
    },

    buildFilters(){
      const pset = new Set(this.raw.teams.map(t => t.platform || t.country).filter(Boolean));
      this.raw.issues.forEach(i => { if (i.platform || i.country) pset.add(i.platform || i.country); });
      this.platforms = [...pset].sort();
      if (!this.platforms.length) this.platforms = ['Web','App','BOSS'];

      const tset = new Set(this.raw.teams.map(t => t.name).filter(Boolean));
      this.teams = [...tset].sort();
    },

    applyFilters(){
      const {platform, team} = this.filters;
      const match = (row)=>{
        const p = row.platform || row.country || '';
        const t = row.team || row.name || '';
        return (!platform || p === platform) && (!team || t === team);
      };

      // execution series
      this.filtered.progressDaily = this.raw.progressDaily.filter(match);
      if (!this.filtered.progressDaily.length) this.filtered.progressDaily = this.raw.progressDaily;

      // defects series
      this.filtered.defectsDaily = (this.raw.defectsDaily || []).filter(match);
      if (!this.filtered.defectsDaily.length) this.filtered.defectsDaily = this.raw.defectsDaily || [];

      // Only Blocker/Critical
      const sevKeep = new Set(['Blocker','Critical']);
      const issuesFiltered = this.raw.issues.filter(i => match(i) && sevKeep.has((i.priority || i.severity || '').trim()));
      this.issuesTotal = issuesFiltered.length;
      this.issues = issuesFiltered.sort((a,b)=>{
        const rank = {Blocker:1, Critical:2, High:3, Medium:4, Low:5};
        return (rank[a.priority || a.severity] || 9) - (rank[b.priority || b.severity] || 9);
      });

      this.computeKpis();
      this.updateCharts(); // safe; guarded below
    },

    // Aggregation for execution charts/KPIs
    aggregateByDate(rows){
      const map = new Map();
      for (const r of rows){
        const d = r.date;
        const inScope = Number(r.inScope) || 0;
        const b = map.get(d) || { inScope:0, exec:0, pass:0, open:0 };
        b.inScope += inScope;
        b.exec    += (Number(r.executedPct)||0)/100 * inScope;
        b.pass    += (Number(r.passPct)||0)/100 * inScope;
        b.open    += Number(r.openDefects)||0;
        map.set(d,b);
      }
      return [...map.entries()].map(([date,b])=>({
        date,
        executedPct: b.inScope ? (b.exec/b.inScope)*100 : 0,
        passPct:     b.inScope ? (b.pass/b.inScope)*100 : 0,
        openDefects: b.open
      })).sort((a,b)=> a.date.localeCompare(b.date));
    },

    // Aggregation for defects burndown
    aggregateDefectsByDate(rows){
      if (!rows || !rows.length) return [];
      const map = new Map();
      for (const r of rows){
        const d = r.date;
        const b = map.get(d) || { open:0 };
        b.open += Number(r.openDefects) || 0;
        map.set(d, b);
      }
      return [...map.entries()]
        .map(([date,b]) => ({ date, openDefects: b.open }))
        .sort((a,b)=> a.date.localeCompare(b.date));
    },

    computeKpis(){
      const execAgg = this.aggregateByDate(this.filtered.progressDaily.length ? this.filtered.progressDaily : this.raw.progressDaily);
      const latest = execAgg[execAgg.length-1] || {};
      this.kpis.inScope     = this.raw.overview.inScope || 0;
      this.kpis.executedPct = latest.executedPct || 0;
      this.kpis.passPct     = latest.passPct || 0;

      const open = this.raw.issues.filter(i=>{
        const p = i.platform || i.country || '';
        const t = i.team || '';
        const m = (!this.filters.platform || p===this.filters.platform) && (!this.filters.team || t===this.filters.team);
        return m && (!i.status || i.status.toLowerCase() !== 'closed');
      });
      this.kpis.openDefects = open.length;
      this.kpis.critical    = open.filter(i=>{
        const sev = (i.priority || i.severity || '').trim();
        return sev === 'Blocker' || sev === 'Critical';
      }).length;
    },

    // ---------- Charts (live) ----------
    drawCharts(){
      if (this.useImageCharts) return;

      try {
        if (this.execChart) { this.execChart.destroy(); this.execChart=null; }
        if (this.defectChart){ this.defectChart.destroy(); this.defectChart=null; }

        const execCtx = document.getElementById('execChart');
        const defectCtx = document.getElementById('defectChart');

        // scatter + time scale for stability
        this.execChart = new Chart(execCtx, {
          type: 'scatter',
          data: { datasets: [
            { label:'Executed %', data: [], showLine:true, tension:.25, borderWidth:2, fill:false,
              borderColor:'#3b82f6', backgroundColor:'#3b82f6', pointRadius:2, spanGaps:true },
            { label:'Pass %', data: [], showLine:true, tension:.25, borderWidth:2, fill:false,
              borderColor:'#ec4899', backgroundColor:'#ec4899', pointRadius:2, spanGaps:true }
          ]},
          options:{
            responsive:true, maintainAspectRatio:false, animation:false, parsing:false,
            scales:{ x:{ type:'time', time:{ unit:'day' } }, y:{ beginAtZero:true, suggestedMax:100, ticks:{ callback:v=>v+'%' } } },
            plugins:{ legend:{ position:'bottom' } }
          }
        });

        this.defectChart = new Chart(defectCtx, {
          type: 'scatter',
          data: { datasets: [
            { label:'Open defects', data: [], showLine:true, tension:.25, borderWidth:2, fill:false,
              borderColor:'#0284c7', backgroundColor:'#0284c7', pointRadius:2, spanGaps:true }
          ]},
          options:{
            responsive:true, maintainAspectRatio:false, animation:false, parsing:false,
            scales:{ x:{ type:'time', time:{ unit:'day' } }, y:{ beginAtZero:true } },
            plugins:{ legend:{ position:'bottom' } }
          }
        });

        this.updateCharts();
      } catch(e){
        console.error('drawCharts error', e);
        this.useImageCharts = true;
        window.dispatchEvent(new CustomEvent('chart-error'));
      }
    },

    // Re-entrancy-safe updates + data sanitization
      updateCharts(){
      if (this.useImageCharts) return;

      // Re-entrancy guard with additional safety check
      if (this.isUpdatingCharts){
        if (!this.pendingChartUpdate){
          this.pendingChartUpdate = requestAnimationFrame(() => {
            this.pendingChartUpdate = null;
            // Add safety check before recursive call
            if (!this.useImageCharts && this.execChart && this.defectChart) {
              this.updateCharts();
            }
          });
        }
        return;
      }

      // Additional safety checks
      if (!this.execChart || !this.defectChart) {
        console.warn('Charts not initialized, skipping update');
        return;
      }

      const validPoint = (p) => p && isFinite(p.y) && !isNaN(p.y) && p.x && !isNaN(new Date(p.x).getTime());
      const dedupe = (arr) => arr.filter((p,i,a)=> i===0 || a[i-1].x !== p.x);

      try{
        this.isUpdatingCharts = true;

        // Execution series
        const execAgg = this.aggregateByDate(
          this.filtered.progressDaily.length ? this.filtered.progressDaily : this.raw.progressDaily
        );
        let execPts = execAgg.map(r => ({ x: r.date, y: Number((r.executedPct ?? 0)) })).filter(validPoint);
        let passPts = execAgg.map(r => ({ x: r.date, y: Number((r.passPct ?? 0)) })).filter(validPoint);

        // Defects series: prefer defectsDaily, fallback to execAgg
        const defectsAggSrc = (this.filtered.defectsDaily && this.filtered.defectsDaily.length)
          ? this.filtered.defectsDaily
          : (this.raw.defectsDaily || []);
        const defectsAgg = defectsAggSrc.length ? this.aggregateDefectsByDate(defectsAggSrc) : execAgg;
        let openPts = defectsAgg.map(r => ({ x: r.date, y: Number(r.openDefects ?? 0) })).filter(validPoint);

        execPts = dedupe(execPts); passPts = dedupe(passPts); openPts = dedupe(openPts);

        // Additional safety checks before updating
        if (this.execChart && !this.execChart.destroyed){
          this.execChart.data.datasets[0].data = execPts;
          this.execChart.data.datasets[1].data = passPts;
          this.execChart.update('none'); // no animation for stability
        }
        if (this.defectChart && !this.defectChart.destroyed){
          this.defectChart.data.datasets[0].data = openPts;
          this.defectChart.update('none');
        }
      }catch(e){
        console.error('updateCharts error', e);
        // Prevent further chart operations
        this.useImageCharts = true;
        // Don't dispatch the event to avoid potential loops
        // window.dispatchEvent(new CustomEvent('chart-error'));
      }finally{
        this.isUpdatingCharts = false;
      }
    }, 

    // ---------- Report ----------
    generateReport(){
      const md = [
        `# UAT Status – ${this.raw.overview.release || 'Release'} (${this.lastUpdate})`,
        ``,
        `**Scope:** ${this.kpis.inScope} | **Executed:** ${this.fmtPct(this.kpis.executedPct)} | **Pass:** ${this.fmtPct(this.kpis.passPct)} | **Open defects:** ${this.kpis.openDefects} | **Blocker/Critical:** ${this.kpis.critical}`,
        ``,
        `## Top Open Issues (Blocker/Critical)`,
        `| Key | Priority | Summary | Owner | Team | Platform |`,
        `|---|---|---|---|---|---|`,
        ...this.issues.map(i=>`| [${i.key}](${i.link||''}) | ${(i.priority||i.severity)} | ${i.summary.replace(/\|/g,'/')} | ${i.owner||''} | ${i.team||''} | ${i.platform||i.country||''} |`)
      ].join('\n');
      this.reportMD = md; 
      this.reportOpen = true;
    },
    copyReport(){ navigator.clipboard.writeText(this.reportMD); },
    downloadReport(){
      const blob = new Blob([this.reportMD], {type:'text/markdown'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `UAT_Status_${(this.lastUpdate||'').replace(/[: ]/g,'_')}.md`;
      a.click();
      URL.revokeObjectURL(a.href);
    },

    fmtPct(v){ return (v??0).toFixed(0)+'%'; },
    sevClass(s){
      const sev = (s||'').trim();
      return sev==='Blocker' ? 'bg-red-100 text-red-700'
           : sev==='Critical'? 'bg-red-50 text-red-700'
           : sev==='High'     ? 'bg-orange-50 text-orange-700'
           : sev==='Medium'   ? 'bg-amber-50 text-amber-700'
           : 'bg-slate-100 text-slate-700';
    }
  }
}

// Register SW (relative scope under /uat-app/)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js', { scope: './' })
      .catch(err => console.error('SW registration failed:', err));
  });
}

document.addEventListener('alpine:init',()=>{Alpine.data('app', app)})
</script>
</body>
</html>
