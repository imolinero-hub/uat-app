<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>UAT Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" sizes="192x192" href="./icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="./icons/icon-512.png">
  <link rel="apple-touch-icon" href="./icons/icon-180.png">
  <meta name="theme-color" content="#111827">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

  <style>
    .card { @apply bg-white rounded-2xl shadow p-4; }
    .badge { @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium; }
    .badge-uat { @apply bg-indigo-50 text-indigo-700; }
    .kpi { @apply text-sm text-gray-500 font-semibold; }
    .kpi-value { @apply text-2xl font-semibold text-gray-900; }
    .chart-wrap { position: relative; height: 220px; }
    .chart-wrap > canvas { position:absolute; inset:0; width:100% !important; height:100% !important; display:block; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="max-w-6xl mx-auto p-4" x-data="app()">
  <!-- Header -->
  <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
    <div>
      <h1 class="text-2xl font-bold">UAT Dashboard</h1>
      <div class="mt-1 flex gap-2 items-center">
        <span class="badge badge-uat">UAT</span>
        <span class="text-xs text-gray-500">Last update: <span x-text="lastUpdate || '—'"></span></span>
      </div>
    </div>

    <!-- Controls: Platform + Generate Status -->
    <div class="flex flex-wrap gap-2">
      <select class="card py-2" x-model="filters.platform" @change="onFilterChange()">
        <option value="">All platforms</option>
        <template x-for="p in platforms" :key="p"><option x-text="p"></option></template>
      </select>
      <button class="card hover:bg-slate-100" @click="generateReport()">Generate Status (MD)</button>
    </div>
  </header>

  <!-- KPIs -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 mb-4">
    <div class="card"><div class="kpi">In Scope</div><div class="kpi-value" x-text="kpis.inScope"></div></div>
    <div class="card"><div class="kpi">Executed %</div><div class="kpi-value" x-text="fmtPct(kpis.executedPct)"></div></div>
    <div class="card"><div class="kpi">Pass %</div><div class="kpi-value" x-text="fmtPct(kpis.passPct)"></div></div>
    <div class="card"><div class="kpi">Open Defects</div><div class="kpi-value" x-text="kpis.openDefects"></div></div>
    <div class="card">
      <div class="kpi">Blocker / Critical</div>
      <div class="kpi-value" :class="kpis.critical > 0 ? 'text-red-600' : 'text-emerald-600'" x-text="kpis.critical"></div>
    </div>
  </section>

  <!-- Charts -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
    <div class="card">
      <div class="mb-2 font-medium">Execution Over Time</div>
      <div class="chart-wrap"><canvas id="execChart"></canvas></div>
    </div>
    <div class="card">
      <div class="mb-2 font-medium">Defect Burndown</div>
      <div class="chart-wrap"><canvas id="defectChart"></canvas></div>
    </div>
  </section>

  <!-- Issues -->
  <section class="card mb-4">
    <div class="flex items-center justify-between mb-2">
      <div class="font-medium">Top Open Issues</div>
      <div class="text-xs text-gray-500" x-text="`Showing ${issues.length} (Blocker/Critical)`"></div>
    </div>
    <table class="min-w-full text-sm">
      <thead class="text-left text-gray-500">
        <tr><th>Key</th><th>Priority</th><th>Summary</th><th>Owner</th><th>Team</th><th>Platform</th></tr>
      </thead>
      <tbody>
        <template x-for="i in issues" :key="i.key">
          <tr class="border-t">
            <td><a :href="i.link" target="_blank" class="text-indigo-600 hover:underline" x-text="i.key"></a></td>
            <td x-text="i.priority"></td>
            <td x-text="i.summary"></td>
            <td x-text="i.owner"></td>
            <td x-text="i.team"></td>
            <td x-text="i.platform"></td>
          </tr>
        </template>
      </tbody>
    </table>
  </section>

  <!-- Key Dates -->
  <section class="card mb-20">
    <div class="font-medium mb-2">Key Dates</div>

    <template x-if="!raw.keyDates || !raw.keyDates.length">
      <div class="text-sm text-gray-500 p-3">No key dates loaded. Check <code>uat.json</code>.</div>
    </template>

    <template x-if="raw.keyDates && raw.keyDates.length">
      <ul class="space-y-2">
        <template x-for="d in raw.keyDates" :key="d.label">
          <li class="flex items-center justify-between">
            <div>
              <div class="font-medium" x-text="d.label"></div>
              <div class="text-xs text-gray-500" x-text="d.notes || ''"></div>
            </div>
            <div class="text-sm" x-text="d.date || d.dateRange || ''"></div>
          </li>
        </template>
      </ul>
    </template>
  </section>

  <!-- Modal: Report -->
  <div x-show="reportOpen" style="display:none" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="font-semibold">Generated Status (Markdown)</div>
        <button class="text-sm text-gray-500 hover:text-gray-700" @click="reportOpen=false">Close</button>
      </div>
      <textarea class="w-full h-64 border rounded-xl p-3 text-sm font-mono" x-text="reportMD"></textarea>
      <div class="mt-3 flex gap-2">
        <button class="card hover:bg-slate-100" @click="copyReport()">Copy</button>
        <button class="card hover:bg-slate-100" @click="downloadReport()">Download .md</button>
      </div>
    </div>
  </div>
</div>

<script>
function app(){
  return {
    raw:{overview:{},progressDaily:[],defectsDaily:[],issues:[],keyDates:[]},
    kpis:{inScope:0,executedPct:0,passPct:0,openDefects:0,critical:0},
    issues:[], lastUpdate:'',
    // platforms
    platforms:[], filters:{ platform:'' },

    async init(){
      const res=await fetch('./uat.json?v='+Date.now(), {cache:'no-store'});
      this.raw=await res.json();

      this.lastUpdate=this.raw.overview?.lastUpdate || '';
      this.platforms = this.getPlatforms();
      this.computeKpis();
      this.drawCharts();
      this.filterIssues();
    },

    getPlatforms(){
      // Build from issues; if none, provide sensible defaults
      const set = new Set(this.raw.issues.map(i => i.platform).filter(Boolean));
      return set.size ? [...set].sort() : ['Web','App','BOSS'];
    },

    onFilterChange(){
      this.computeKpis();
      this.filterIssues();
    },

    computeKpis(){
      // Execution KPIs from last progressDaily point (overall)
      const p=this.raw.progressDaily;
      if(p.length){
        const last=p[p.length-1];
        this.kpis.inScope=last.inScope||0;
        this.kpis.executedPct=last.executedPct||0;
        this.kpis.passPct=last.passPct||0;
      } else {
        this.kpis.inScope=0; this.kpis.executedPct=0; this.kpis.passPct=0;
      }

      // Defect KPIs (filtered by platform selection)
      const plat = this.filters.platform;
      const open = this.raw.issues.filter(i=>{
        const isOpen = !i.status || i.status.toLowerCase()!=='closed';
        const matches = !plat || i.platform===plat;
        return isOpen && matches;
      });
      this.kpis.openDefects = open.length;
      this.kpis.critical = open.filter(i=>['Blocker','Critical'].includes(i.priority)).length;
    },

    drawCharts(){
      // Execution
      new Chart(document.getElementById('execChart'),{
        type:'line',
        data:{datasets:[
          {label:'Executed %',data:this.raw.progressDaily.map(r=>({x:r.date,y:r.executedPct})),borderColor:'#3b82f6',pointRadius:2,tension:.25},
          {label:'Pass %',data:this.raw.progressDaily.map(r=>({x:r.date,y:r.passPct})),borderColor:'#ec4899',pointRadius:2,tension:.25}
        ]},
        options:{responsive:true,maintainAspectRatio:false,animation:false,
          scales:{x:{type:'time',time:{unit:'day'}},y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}}},
          plugins:{legend:{position:'bottom'}}
        }
      });

      // Defects (overall series; if you later add platform on defectsDaily, we can filter here too)
      new Chart(document.getElementById('defectChart'),{
        type:'line',
        data:{datasets:[{label:'Open Defects',data:this.raw.defectsDaily.map(r=>({x:r.date,y:r.openDefects})),borderColor:'#0284c7',pointRadius:2,tension:.25}]},
        options:{responsive:true,maintainAspectRatio:false,animation:false,
          scales:{x:{type:'time',time:{unit:'day'}},y:{beginAtZero:true}},
          plugins:{legend:{position:'bottom'}}
        }
      });
    },

    filterIssues(){
      const plat = this.filters.platform;
      this.issues = this.raw.issues
        .filter(i => (!plat || i.platform===plat))
        .filter(i => ['Blocker','Critical'].includes(i.priority));
    },

    // ---- Report ----
    generateReport(){
      const plat = this.filters.platform || 'All platforms';
      const md = [
        `# UAT Status – ${this.raw.overview.release || 'Release'} (${this.lastUpdate})`,
        ``,
        `**Platform:** ${plat}`,
        ``,
        `**Scope:** ${this.kpis.inScope} | **Executed:** ${this.fmtPct(this.kpis.executedPct)} | **Pass:** ${this.fmtPct(this.kpis.passPct)} | **Open defects:** ${this.kpis.openDefects} | **Blocker/Critical:** ${this.kpis.critical}`,
        ``,
        `## Top Open Issues (Blocker/Critical)`,
        `| Key | Priority | Summary | Owner | Team | Platform |`,
        `|---|---|---|---|---|---|`,
        ...this.issues.map(i=>`| [${i.key}](${i.link||''}) | ${i.priority} | ${i.summary.replace(/\|/g,'/')} | ${i.owner||''} | ${i.team||''} | ${i.platform||''} |`)
      ].join('\n');
      this.reportMD = md;
      this.reportOpen = true;
    },
    copyReport(){ navigator.clipboard.writeText(this.reportMD); },
    downloadReport(){
      const blob = new Blob([this.reportMD], {type:'text/markdown'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `UAT_Status_${(this.lastUpdate||'').replace(/[: ]/g,'_')}.md`;
      a.click();
      URL.revokeObjectURL(a.href);
    },

    reportOpen:false, reportMD:'',
    fmtPct(v){return (v??0)+'%';}
  }
}
document.addEventListener('alpine:init',()=>{Alpine.data('app',app)})
</script>
</body>
</html>
