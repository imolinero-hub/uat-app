<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>UAT Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" sizes="192x192" href="./icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="./icons/icon-512.png">
  <link rel="apple-touch-icon" href="./icons/icon-180.png">
  <meta name="theme-color" content="#111827">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

  <style>
    .card { @apply bg-white rounded-2xl shadow p-4; }
    .badge { @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium; }
    .badge-uat { @apply bg-indigo-50 text-indigo-700; }
    .kpi { @apply text-sm text-gray-500 font-semibold; }
    .kpi-value { @apply text-2xl font-semibold text-gray-900; }
    .chart-wrap { position: relative; height: 220px; }
    .chart-wrap > canvas { position:absolute; inset:0; width:100% !important; height:100% !important; display:block; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="max-w-6xl mx-auto p-4" x-data="app()">
  <!-- Header -->
  <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
    <div>
      <h1 class="text-2xl font-bold">UAT Dashboard</h1>
      <div class="mt-1 flex gap-2 items-center">
        <span class="badge badge-uat">UAT</span>
        <span class="text-xs text-gray-500">Last update: <span x-text="lastUpdate || 'â€”'"></span></span>
      </div>
    </div>
  </header>

  <!-- KPIs -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 mb-4">
    <div class="card"><div class="kpi">In Scope</div><div class="kpi-value" x-text="kpis.inScope"></div></div>
    <div class="card"><div class="kpi">Executed %</div><div class="kpi-value" x-text="fmtPct(kpis.executedPct)"></div></div>
    <div class="card"><div class="kpi">Pass %</div><div class="kpi-value" x-text="fmtPct(kpis.passPct)"></div></div>
    <div class="card"><div class="kpi">Open Defects</div><div class="kpi-value" x-text="kpis.openDefects"></div></div>
    <div class="card">
      <div class="kpi">Blocker / Critical</div>
      <div class="kpi-value" :class="kpis.critical > 0 ? 'text-red-600' : 'text-emerald-600'" x-text="kpis.critical"></div>
    </div>
  </section>

  <!-- Charts -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
    <div class="card">
      <div class="mb-2 font-medium">Execution Over Time</div>
      <div class="chart-wrap"><canvas id="execChart"></canvas></div>
    </div>
    <div class="card">
      <div class="mb-2 font-medium">Defect Burndown</div>
      <div class="chart-wrap"><canvas id="defectChart"></canvas></div>
    </div>
  </section>

  <!-- Issues -->
  <section class="card mb-4">
    <div class="flex items-center justify-between mb-2">
      <div class="font-medium">Top Open Issues</div>
      <div class="text-xs text-gray-500" x-text="`Showing ${issues.length} (Blocker/Critical)`"></div>
    </div>
    <table class="min-w-full text-sm">
      <thead class="text-left text-gray-500">
        <tr><th>Key</th><th>Priority</th><th>Summary</th><th>Owner</th><th>Team</th><th>Platform</th></tr>
      </thead>
      <tbody>
        <template x-for="i in issues" :key="i.key">
          <tr class="border-t">
            <td><a :href="i.link" target="_blank" class="text-indigo-600" x-text="i.key"></a></td>
            <td x-text="i.priority"></td>
            <td x-text="i.summary"></td>
            <td x-text="i.owner"></td>
            <td x-text="i.team"></td>
            <td x-text="i.platform"></td>
          </tr>
        </template>
      </tbody>
    </table>
  </section>

  <!-- Key Dates -->
  <section class="card mb-20">
    <div class="font-medium mb-2">Key Dates</div>
    <template x-for="d in raw.keyDates" :key="d.label">
      <div class="flex justify-between">
        <div><div class="font-semibold" x-text="d.label"></div><div class="text-xs text-gray-500" x-text="d.notes"></div></div>
        <div class="text-sm" x-text="d.date"></div>
      </div>
    </template>
  </section>
</div>

<script>
function app(){
  return {
    raw:{overview:{},progressDaily:[],defectsDaily:[],issues:[],keyDates:[]},
    kpis:{inScope:0,executedPct:0,passPct:0,openDefects:0,critical:0},
    issues:[], lastUpdate:'',

    async init(){
      const res=await fetch('./uat.json?v='+Date.now()); 
      this.raw=await res.json();
      this.lastUpdate=this.raw.overview.lastUpdate;
      this.computeKpis();
      this.drawCharts();
      this.filterIssues();
    },

    computeKpis(){
      const p=this.raw.progressDaily; 
      const d=this.raw.defectsDaily;
      if(p.length){this.kpis.inScope=p[p.length-1].inScope;this.kpis.executedPct=p[p.length-1].executedPct;this.kpis.passPct=p[p.length-1].passPct;}
      if(d.length){this.kpis.openDefects=d[d.length-1].openDefects;}
      this.kpis.critical=this.raw.issues.filter(i=>['Blocker','Critical'].includes(i.priority)).length;
    },

    drawCharts(){
      const exec=new Chart(document.getElementById('execChart'),{
        type:'line',
        data:{datasets:[
          {label:'Executed %',data:this.raw.progressDaily.map(r=>({x:r.date,y:r.executedPct})),borderColor:'#3b82f6'},
          {label:'Pass %',data:this.raw.progressDaily.map(r=>({x:r.date,y:r.passPct})),borderColor:'#ec4899'}
        ]},
        options:{scales:{x:{type:'time',time:{unit:'day'}},y:{beginAtZero:true,max:100}}}
      });
      const defect=new Chart(document.getElementById('defectChart'),{
        type:'line',
        data:{datasets:[{label:'Open Defects',data:this.raw.defectsDaily.map(r=>({x:r.date,y:r.openDefects})),borderColor:'#0284c7'}]},
        options:{scales:{x:{type:'time',time:{unit:'day'}},y:{beginAtZero:true}}}
      });
    },

    filterIssues(){
      this.issues=this.raw.issues.filter(i=>['Blocker','Critical'].includes(i.priority));
    },

    fmtPct(v){return (v??0)+'%';}
  }
}
document.addEventListener('alpine:init',()=>{Alpine.data('app',app)})
</script>
</body>
</html>
