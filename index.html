<!doctype html>
<html lang="en">
<head>
  <!--
    UAT Dashboard (Leadership View) — modular split
    Author: Ildefonso Molinero
  -->
  <meta charset="utf-8" />
  <title>UAT Dashboard · Leadership View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- PWA (optional) -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" sizes="192x192" href="./icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="./icons/icon-512.png">
  <link rel="apple-touch-icon" href="./icons/icon-180.png">
  <meta name="theme-color" content="#0b1220">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Tailwind v2 (fallback) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">
  <!-- Tailwind v3 Play (preferred) -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography" crossorigin="anonymous"></script>

  <!-- Our styles (extracted) -->
  <link rel="stylesheet" href="./styles.css" />

  <!-- Alpine.js (reactive layer) -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" crossorigin="anonymous"></script>
  <!-- Chart.js + time adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3" crossorigin="anonymous"></script>
</head>

<body x-data="app()" x-init="initTheme()" :class="theme">
<div class="max-w-6xl mx-auto px-4 py-5">

  <!-- ============================== HEADER ============================== -->
  <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-5">
    <div class="flex items-center gap-3">
      <!-- Theme toggle -->
      <button class="icon-btn ring" @click="toggleTheme()" :title="theme==='theme-light' ? 'Switch to dark' : 'Switch to light'"
              :style="'background:linear-gradient(135deg,rgba(14,165,233,.25),rgba(99,102,241,.25))'">
        <template x-if="theme!=='theme-light'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </template>
        <template x-if="theme==='theme-light'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="5" stroke="#111" stroke-width="2"/><path d="M12 1v3m0 16v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M1 12h3m16 0h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12" stroke="#111" stroke-width="2" stroke-linecap="round"/></svg>
        </template>
      </button>

      <div>
        <div class="text-xl font-semibold tracking-tight">UAT Dashboard</div>
        <div class="text-[12px] text-slate-400 flex items-center gap-2">
          <span x-text="raw.overview?.release || 'Release'"></span>
          <span class="opacity-40">•</span>
          Last update: <span class="text-slate-300" x-text="lastUpdate || '—'"></span>
        </div>
      </div>
    </div>

    <div class="flex flex-wrap items-center gap-2">
      <!-- Compact UAT Days badge -->
      <div class="flex items-center">
        <div class="pill-lg" :title="countdown.tooltip">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="mr-2">
            <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
            <path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span class="font-semibold" x-text="countdown.compact"></span>
        </div>
      </div>

      <!-- Platform filter -->
      <select class="glass btn text-sm text-slate-200 theme-light:text-slate-800" x-model="filters.platform" @change="onFilterChange()">
        <option value="">All platforms</option>
        <template x-for="p in platforms" :key="p"><option x-text="p"></option></template>
      </select>

      <!-- Info modal trigger -->
      <button class="btn" @click="openInfo()">
        <span class="inline-flex items-center gap-2">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/><path d="M12 8h.01M11 11h2v5h-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          Info
        </span>
      </button>

      <!-- AI Daily Status -->
      <button class="btn btn-primary" @click="generateAIStatus()">AI Daily Status</button>
    </div>
  </header>

  <!-- ============================== KPIs ============================== -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
    <div class="card p-4"><div class="kpi-label">In Scope</div><div class="kpi-value mt-1" x-text="kpis.inScope"></div></div>
    <div class="card p-4"><div class="kpi-label">Executed %</div><div class="kpi-value mt-1" :class="kpiColor(kpis.executedPct)" x-text="fmtPct(kpis.executedPct)"></div></div>
    <div class="card p-4"><div class="kpi-label">Pass %</div><div class="kpi-value mt-1" :class="kpiColor(kpis.passPct)" x-text="fmtPct(kpis.passPct)"></div></div>
    <div class="card p-4"><div class="kpi-label">Open Defects</div><div class="kpi-value mt-1" x-text="kpis.openDefects"></div></div>
    <div class="card p-4"><div class="kpi-label">Blocker / Critical</div><div class="kpi-value mt-1" :class="kpis.critical>0?'text-rose-400':'text-emerald-400'" x-text="kpis.critical"></div></div>
  </section>

  <!-- ============================== AI Status (panel) ============================== -->
  <section class="panel overflow-hidden mb-6" x-show="aiOpen" x-transition>
    <div class="px-5 py-4 flex items-center justify-between"
         style="background: linear-gradient(180deg, rgba(99,102,241,.12), transparent);">
      <div class="flex items-center gap-2">
        <span class="badge"><span class="badge-dot" style="background:#22c55e"></span> Daily</span>
        <div class="font-semibold">Daily Status (AI-generated)</div>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-xs text-slate-400">For leadership • concise & action-oriented</div>
        <button class="btn icon-btn" aria-label="Close" @click="aiOpen=false" title="Hide">✕</button>
      </div>
    </div>
    <div class="h-px bg-white/10 theme-light:bg-black/10"></div>

    <div class="p-5">
      <div class="prose prose-invert max-w-none text-[15px] leading-6 theme-light:prose">
        <div x-show="!aiStatus" class="text-slate-400">Click <strong>AI Daily Status</strong> to generate today’s summary.</div>
        <div x-show="aiStatus" x-html="aiStatus"></div>
      </div>
      <div class="mt-4 flex flex-wrap gap-2">
        <button class="btn" @click="copyAI()">Copy</button>
        <button class="btn" @click="downloadAI()">Download .md</button>
      </div>
    </div>
  </section>

  <!-- ============================== CHARTS ============================== -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium">Execution Over Time</div>
        <span class="pill">Executed% · Pass%</span>
      </div>
      <div class="chart-wrap"><canvas id="execChart"></canvas></div>
    </div>
    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium">Defect Burndown</div>
        <span class="pill">Open defects</span>
      </div>
      <div class="chart-wrap"><canvas id="defectChart"></canvas></div>
    </div>
  </section>

  <!-- ============================== ISSUES TABLE ============================== -->
  <section class="card p-4 mb-6">
    <div class="flex items-center justify-between mb-2">
      <div class="font-medium">Blocker / Critical Defects</div>
      <div class="text-xs text-slate-400" x-text="`Showing ${issues.length}`"></div>
    </div>
    <div class="overflow-x-auto">
      <table class="table w-full text-sm">
        <thead>
          <tr><th>Key</th><th>Priority</th><th>Summary</th><th>Reporter</th><th>Team</th><th>Platform</th></tr>
        </thead>
        <tbody>
          <template x-for="i in issues" :key="i.key">
            <tr>
              <td><a class="link hover:underline" :href="i.link" target="_blank" x-text="i.key"></a></td>
              <td>
                <span class="badge">
                  <span class="badge-dot" :style="sevDot(i.priority)"></span>
                  <span x-text="i.priority"></span>
                </span>
              </td>
              <td x-text="i.summary"></td>
              <td x-text="i.reporter || i.owner || '—'"></td>
              <td x-text="i.team || '—'"></td>
              <td x-text="i.platform || '—'"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ============================== KEY DATES ============================== -->
  <section class="card p-4 mb-16">
    <div class="font-medium mb-3">Key Dates</div>
    <template x-if="raw.keyDates && raw.keyDates.length">
      <ul class="space-y-3">
        <template x-for="d in raw.keyDates" :key="d.label">
          <li class="flex items-start gap-3">
            <div class="timeline-dot mt-1.5"></div>
            <div class="flex-1">
              <div class="font-medium" x-text="d.label"></div>
              <div class="text-xs text-slate-400" x-text="d.notes || ''"></div>
            </div>
            <div class="text-sm text-slate-300" x-text="d.date || d.dateRange || ''"></div>
          </li>
        </template>
      </ul>
    </template>
    <template x-if="!raw.keyDates || !raw.keyDates.length">
      <div class="text-sm text-slate-400">No key dates loaded.</div>
    </template>
  </section>

  <!-- ============================== INFO MODAL ============================== -->
  <div x-show="infoOpen" x-transition.opacity class="fixed inset-0 bg-black/85 backdrop-blur-[1px] grid place-items-center p-4 z-50">
    <div class="panel max-w-2xl w-full p-5 relative">
      <button class="icon-btn absolute -top-3 -right-3 btn" @click="infoOpen=false" aria-label="Close">✕</button>
      <div class="font-semibold mb-3">UAT Overview</div>
      <div class="prose prose-invert theme-light:prose max-w-none text-[15px]" x-html="infoHtml || '<p class=&quot;text-slate-400&quot;>No info loaded.</p>'"></div>
    </div>
  </div>

</div>

<!-- Our app script (extracted) -->
<script src="./app.js"></script>

<!-- Optional PWA registration (still commented)
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('./service-worker.js');
      setInterval(() => reg.update(), 30 * 60 * 1000);
    } catch (e) { console.warn('SW failed', e); }
  });
}
</script>
-->

<!-- Footer -->
<footer class="mt-10 pb-6 text-center text-xs text-slate-400 opacity-70 select-none">
  <span>Author: Ildefonso Molinero</span>
</footer>

</body>
</html>
