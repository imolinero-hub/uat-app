<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>UAT Dashboard</title>

  <!-- Simple build/version marker you can bump on each deploy -->
  <meta name="app-version" content="2025.09.04.1" />

  <!-- (Optional) PWA bits -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" sizes="192x192" href="./icons/icon-192.png" />
  <link rel="apple-touch-icon" href="./icons/icon-180.png" />
  <meta name="theme-color" content="#0b1020" />

  <!-- Tailwind via CDN (keep simple: no plugins to avoid CORS/SRI issues on GH Pages) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js + date adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <!-- Alpine.js (lightweight reactivity) -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.1/dist/cdn.min.js"></script>

  <!-- Your modular CSS -->
  <link rel="stylesheet" href="./styles.css" />

  <!-- Your modular App logic -->
  <script defer src="./app.js"></script>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900">
  <div
    class="mx-auto max-w-7xl px-4 py-6"
    x-data="app"
    x-init="init()"
  >
    <!-- Header / Title row -->
    <div class="flex flex-wrap items-center gap-3">
      <div class="flex items-center gap-2">
        <div class="h-9 w-9 rounded-2xl bg-indigo-100 text-indigo-700 grid place-items-center">
          <span class="text-lg">‚ú®</span>
        </div>
        <div>
          <h1 class="text-2xl font-semibold leading-6">UAT Dashboard</h1>
          <div class="text-sm text-slate-500">
            <span class="mr-2">RI-4</span>
            <span>Last update: <span x-text="lastUpdate || '‚Äî'"></span></span>
          </div>
        </div>
      </div>

      <div class="ml-auto flex items-center gap-3">
        <!-- UAT days pill -->
        <div class="rounded-full bg-slate-100 px-3 py-1 text-sm flex items-center gap-2">
          <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-slate-200">
            üìÖ
          </span>
          <span x-text="countdown.compact"></span>
        </div>

        <!-- Health badge -->
        <div :class="health.className" class="rounded-full px-2.5 py-1 text-sm" x-text="health.label" :title="health.tooltip"></div>

        <!-- Platform filter -->
        <div class="relative">
          <select
            class="pill-select"
            x-model="filters.platform"
            @change="applyFilters()"
          >
            <option value="ALL">All platforms</option>
            <template x-for="p in platforms" :key="p">
              <option :value="p" x-text="p"></option>
            </template>
          </select>
        </div>

        <!-- Info -->
        <button
          class="btn-secondary"
          @click="showInfo = true"
          title="UAT overview"
        >
          <span class="mr-1">‚ÑπÔ∏è</span> Info
        </button>

        <!-- AI Daily Status -->
        <button class="btn-primary" @click="generateReport()">
          AI Daily Status
        </button>
      </div>
    </div>

    <!-- KPI cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
      <div class="card">
        <div class="text-sm text-slate-600 mb-1">In Scope</div>
        <div class="text-3xl font-semibold" x-text="kpis.inScope?.toLocaleString() || '‚Äî'"></div>
      </div>
      <div class="card">
        <div class="text-sm text-slate-600 mb-1">Executed %</div>
        <div class="text-3xl font-semibold" x-text="fmtPct(kpis.executedPct)"></div>
      </div>
      <div class="card">
        <div class="text-sm text-slate-600 mb-1">Pass %</div>
        <div class="text-3xl font-semibold" x-text="fmtPct(kpis.passPct)"></div>
      </div>
      <div class="card">
        <div class="text-sm text-slate-600 mb-1">Open Defects</div>
        <div class="text-3xl font-semibold" x-text="kpis.openDefects?.toLocaleString() || '‚Äî'"></div>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-6">
      <!-- Execution Over Time -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold text-slate-700">Execution Over Time</h2>
          <div class="text-xs text-slate-500">Executed% ¬∑ Pass%</div>
        </div>
        <canvas id="execChart" height="140"></canvas>
      </div>

      <!-- Defect Burndown -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold text-slate-700">Defect Burndown</h2>
          <div class="text-xs text-slate-500">Open defects</div>
        </div>
        <canvas id="defectChart" height="140"></canvas>
      </div>
    </div>

    <!-- Issues table -->
    <div class="card mt-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold text-slate-700">Blocker / Critical Defects</h2>
        <div class="text-xs text-slate-500" x-text="`Showing ${issues.length}`"></div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-slate-500">
              <th class="py-2 pr-4">Key</th>
              <th class="py-2 pr-4">Priority</th>
              <th class="py-2 pr-4">Summary</th>
              <th class="py-2 pr-4">Reporter</th>
              <th class="py-2 pr-4">Team</th>
              <th class="py-2 pr-4">Platform</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="it in issues" :key="it.key">
              <tr class="border-t border-slate-100">
                <td class="py-2 pr-4">
                  <a :href="it.link" target="_blank" class="text-indigo-600 hover:underline" x-text="it.key"></a>
                </td>
                <td class="py-2 pr-4">
                  <span class="badge" x-text="it.priority"></span>
                </td>
                <td class="py-2 pr-4" x-text="it.summary"></td>
                <td class="py-2 pr-4" x-text="it.reporter"></td>
                <td class="py-2 pr-4" x-text="it.team"></td>
                <td class="py-2 pr-4" x-text="it.platform"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modals -->

    <!-- Info modal -->
    <div
      class="modal"
      x-show="showInfo"
      x-transition.opacity
      @keydown.escape.window="showInfo=false"
    >
      <div class="modal-card" @click.outside="showInfo=false">
        <div class="modal-header">
          <h3 class="modal-title">UAT Overview</h3>
          <button class="modal-close" @click="showInfo=false">‚úï</button>
        </div>
        <div class="prose max-w-none text-sm" x-html="infoHtml"></div>
      </div>
    </div>

    <!-- AI Daily Status modal -->
    <div
      class="modal"
      x-show="showReport"
      x-transition.opacity
      @keydown.escape.window="showReport=false"
    >
      <div class="modal-card" @click.outside="showReport=false">
        <div class="modal-header">
          <h3 class="modal-title">Daily Status (AI-generated)</h3>
          <button class="modal-close" @click="showReport=false">‚úï</button>
        </div>
        <div class="text-xs text-slate-500 mb-3">For leadership ‚Ä¢ concise &amp; action-oriented</div>
        <textarea class="w-full h-64 border rounded-xl p-3 text-sm font-mono" x-text="reportHtml"></textarea>
        <div class="mt-3 flex gap-2">
          <button class="btn-secondary" @click="copyReport()">Copy</button>
          <button class="btn-secondary" @click="downloadReport()">Download .md</button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-10 pb-6 text-center text-xs text-slate-400 select-none">
      <span>Author: Ildefonso Molinero</span>
    </footer>
  </div>

  <!-- Versioned Service Worker registration (cache-busts on each deploy) -->
  <script>
    window.addEventListener('load', () => {
      if ('serviceWorker' in navigator) {
        const v = document.querySelector('meta[name="app-version"]')?.content || String(Date.now());
        navigator.serviceWorker.register(`./service-worker.js?v=${encodeURIComponent(v)}`);
      }
    });
  </script>
</body>
</html>
