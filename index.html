<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>UAT Dashboard · Leadership View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- PWA bits (paths relative to /uat-app/) -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" sizes="192x192" href="./icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="./icons/icon-512.png">
  <link rel="apple-touch-icon" href="./icons/icon-180.png">
  <meta name="theme-color" content="#0b1220">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Chart.js + time adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

  <style>
    /* Design tokens */
    :root{
      --bg: #0b1220;          /* page background */
      --card: #0f172a;        /* card background */
      --muted: #94a3b8;       /* secondary text */
      --ring: 255 255 255/0.1;
      --grad-1: linear-gradient(135deg,#0ea5e9 0%,#6366f1 50%,#22c55e 100%);
    }
    body{ background: radial-gradient(1200px 800px at 20% -10%, rgba(59,130,246,.25), transparent 40%),
                      radial-gradient(1000px 600px at 120% 0%, rgba(34,197,94,.18), transparent 35%),
                      var(--bg); }
    .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); }
    .card  { background: var(--card); border: 1px solid rgba(255,255,255,.06); border-radius: 1.25rem; }
    .ring  { box-shadow: 0 0 0 1px rgba(var(--ring)); }
    .kpi-label{ font-size:.75rem; letter-spacing:.02em; color:var(--muted); font-weight:600 }
    .kpi-value{ font-size:1.6rem; font-weight:700 }
    .chart-wrap{ position: relative; height: 240px; }
    .chart-wrap > canvas{ position:absolute; inset:0; width:100% !important; height:100% !important }
    .pill{ border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); border-radius:999px; padding:.2rem .6rem; font-size:.72rem }
    .btn{ border:1px solid rgba(255,255,255,.12); border-radius: .9rem; padding:.55rem .9rem; }
    .btn:hover{ background: rgba(255,255,255,.05) }
    .btn-primary{ background-image: var(--grad-1); border: none; color: white; }
    .btn-primary:hover{ filter: brightness(.98) }
    .badge{
      display:inline-flex; align-items:center; gap:.35rem; font-size:.72rem; padding:.2rem .55rem;
      border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04);
    }
    .badge-dot{ width:.5rem; height:.5rem; border-radius:999px }
    .timeline-dot{ width:.6rem; height:.6rem; border-radius:999px; background:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.2) }
    .table th, .table td{ padding:.6rem .75rem; }
    .table thead th{ font-size:.75rem; color:var(--muted); font-weight:600; border-bottom:1px solid rgba(255,255,255,.08) }
    .table tbody tr{ border-bottom:1px solid rgba(255,255,255,.06) }
    .link{ color:#60a5fa }
  </style>
</head>
<body class="text-slate-100">
<div class="max-w-5xl mx-auto px-4 py-5" x-data="app()">

  <!-- Top bar -->
  <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-5">
    <div class="flex items-center gap-3">
      <div class="h-9 w-9 rounded-xl ring flex items-center justify-center"
           style="background:linear-gradient(135deg,rgba(14,165,233,.25),rgba(99,102,241,.25));">
        <!-- simple logo -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 12h16M12 4v16" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
      </div>
      <div>
        <div class="text-xl font-semibold tracking-tight">UAT Dashboard</div>
        <div class="text-[12px] text-slate-400 flex items-center gap-2">
          <span x-text="raw.overview?.release || 'Release'"></span>
          <span class="opacity-40">•</span>
          Last update: <span class="text-slate-300" x-text="lastUpdate || '—'"></span>
        </div>
      </div>
    </div>

    <div class="flex flex-wrap items-center gap-2">
      <!-- Platform filter -->
      <select class="glass btn text-sm text-slate-200" x-model="filters.platform" @change="onFilterChange()">
        <option value="">All platforms</option>
        <template x-for="p in platforms" :key="p"><option x-text="p"></option></template>
      </select>

      <!-- AI Status -->
      <button class="btn btn-primary" @click="generateAIStatus()">
        <span>AI Daily Status</span>
      </button>
    </div>
  </header>

  <!-- KPI ribbon -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
    <div class="card p-4">
      <div class="kpi-label">In Scope</div>
      <div class="kpi-value mt-1" x-text="kpis.inScope"></div>
    </div>
    <div class="card p-4">
      <div class="kpi-label">Executed %</div>
      <div class="kpi-value mt-1" :class="kpiColor(kpis.executedPct)" x-text="fmtPct(kpis.executedPct)"></div>
    </div>
    <div class="card p-4">
      <div class="kpi-label">Pass %</div>
      <div class="kpi-value mt-1" :class="kpiColor(kpis.passPct)" x-text="fmtPct(kpis.passPct)"></div>
    </div>
    <div class="card p-4">
      <div class="kpi-label">Open Defects</div>
      <div class="kpi-value mt-1" x-text="kpis.openDefects"></div>
    </div>
    <div class="card p-4">
      <div class="kpi-label">Blocker / Critical</div>
      <div class="kpi-value mt-1" :class="kpis.critical>0?'text-rose-400':'text-emerald-400'" x-text="kpis.critical"></div>
    </div>
  </section>

  <!-- AI Daily Status -->
  <section class="card p-0 overflow-hidden mb-6">
    <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between"
         style="background: linear-gradient(180deg, rgba(99,102,241,.12), transparent);">
      <div class="flex items-center gap-2">
        <span class="badge"><span class="badge-dot" style="background:#22c55e"></span> Daily</span>
        <div class="font-semibold">Daily Status (AI-generated)</div>
      </div>
      <div class="text-xs text-slate-400">For leadership • concise & action-oriented</div>
    </div>
    <div class="p-5">
      <div class="prose prose-invert max-w-none text-[15px] leading-6">
        <div x-show="!aiStatus" class="text-slate-400">Click <strong>AI Daily Status</strong> to generate today’s summary.</div>
        <div x-show="aiStatus" x-html="aiStatus"></div>
      </div>
      <div class="mt-4 flex flex-wrap gap-2">
        <button class="btn" @click="copyAI()">Copy</button>
        <button class="btn" @click="downloadAI()">Download .md</button>
      </div>
    </div>
  </section>

  <!-- Charts -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium">Execution Over Time</div>
        <span class="pill">Executed% &nbsp;·&nbsp; Pass%</span>
      </div>
      <div class="chart-wrap"><canvas id="execChart"></canvas></div>
    </div>
    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium">Defect Burndown</div>
        <span class="pill">Open defects</span>
      </div>
      <div class="chart-wrap"><canvas id="defectChart"></canvas></div>
    </div>
  </section>

  <!-- Issues -->
  <section class="card p-4 mb-6">
    <div class="flex items-center justify-between mb-2">
      <div class="font-medium">Top Blocker / Critical Issues</div>
      <div class="text-xs text-slate-400" x-text="`Showing ${issues.length}`"></div>
    </div>
    <div class="overflow-x-auto">
      <table class="table w-full text-sm">
        <thead>
          <tr>
            <th>Key</th><th>Priority</th><th>Summary</th><th>Owner</th><th>Team</th><th>Platform</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="i in issues" :key="i.key">
            <tr>
              <td><a class="link hover:underline" :href="i.link" target="_blank" x-text="i.key"></a></td>
              <td>
                <span class="badge" :style="sevBadge(i.priority)"><span class="badge-dot" :style="sevDot(i.priority)"></span><span x-text="i.priority"></span></span>
              </td>
              <td x-text="i.summary"></td>
              <td x-text="i.owner || '—'"></td>
              <td x-text="i.team || '—'"></td>
              <td x-text="i.platform || '—'"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Key Dates -->
  <section class="card p-4 mb-16">
    <div class="font-medium mb-3">Key Dates</div>
    <template x-if="!raw.keyDates || !raw.keyDates.length">
      <div class="text-sm text-slate-400">No key dates loaded. Check <code>uat.json</code>.</div>
    </template>
    <template x-if="raw.keyDates && raw.keyDates.length">
      <ul class="space-y-3">
        <template x-for="d in raw.keyDates" :key="d.label">
          <li class="flex items-start gap-3">
            <div class="timeline-dot mt-1.5"></div>
            <div class="flex-1">
              <div class="font-medium" x-text="d.label"></div>
              <div class="text-xs text-slate-400" x-text="d.notes || ''"></div>
            </div>
            <div class="text-sm text-slate-300" x-text="d.date || d.dateRange || ''"></div>
          </li>
        </template>
      </ul>
    </template>
  </section>
</div>

<script>
function app(){
  return {
    // --- State ---
    raw:{ overview:{}, progressDaily:[], defectsDaily:[], issues:[], keyDates:[] },
    kpis:{ inScope:0, executedPct:0, passPct:0, openDefects:0, critical:0 },
    platforms:[], filters:{ platform:'' },
    lastUpdate:'', issues:[],
    execChart:null, defectChart:null,
    aiStatus:'',  // HTML rendered from Markdown-like content

    // --- Lifecycle ---
    async init(){
      try{
        const res = await fetch('./uat.json?v=' + Date.now(), { cache:'no-store' });
        if(res.ok) this.raw = await res.json();
      }catch(e){ console.error('Failed to load uat.json', e); }

      this.lastUpdate = this.raw.overview?.lastUpdate || '';
      this.platforms = this.getPlatforms();
      this.computeKpis();
      this.drawCharts();
      this.filterIssues();
    },

    // --- Helpers ---
    getPlatforms(){
      const set = new Set(this.raw.issues.map(i=>i.platform).filter(Boolean));
      return set.size ? [...set].sort() : ['Web','App','BOSS'];
    },
    onFilterChange(){ this.computeKpis(); this.filterIssues(); },

    computeKpis(){
      const p = this.raw.progressDaily;
      if(p.length){
        const last = p[p.length-1];
        this.kpis.inScope = last.inScope || this.raw.overview?.inScope || 0;
        this.kpis.executedPct = +last.executedPct || 0;
        this.kpis.passPct = +last.passPct || 0;
      } else {
        this.kpis.inScope = this.raw.overview?.inScope || 0;
        this.kpis.executedPct = 0; this.kpis.passPct = 0;
      }

      const plat = this.filters.platform;
      const open = this.raw.issues.filter(i=>{
        const isOpen = !i.status || i.status.toLowerCase() !== 'closed';
        const matches = !plat || i.platform === plat;
        return isOpen && matches;
      });
      this.kpis.openDefects = open.length;
      this.kpis.critical = open.filter(i=>['Blocker','Critical'].includes(i.priority)).length;
    },

    drawCharts(){
      // Execution chart
      if(this.execChart){ this.execChart.destroy(); }
      this.execChart = new Chart(document.getElementById('execChart'), {
        type:'line',
        data:{ datasets:[
          {label:'Executed %', data:this.raw.progressDaily.map(r=>({x:r.date,y:+r.executedPct})),
           borderColor:'#60a5fa', backgroundColor:'#60a5fa', pointRadius:2, tension:.25},
          {label:'Pass %', data:this.raw.progressDaily.map(r=>({x:r.date,y:+r.passPct})),
           borderColor:'#a78bfa', backgroundColor:'#a78bfa', pointRadius:2, tension:.25}
        ]},
        options:{
          responsive:true, maintainAspectRatio:false, animation:false,
          scales:{ x:{ type:'time', time:{ unit:'day' }, grid:{ color:'rgba(255,255,255,.06)'} },
                  y:{ beginAtZero:true, max:100, ticks:{ callback:v=>v+'%' }, grid:{ color:'rgba(255,255,255,.06)'} } },
          plugins:{ legend:{ position:'bottom', labels:{ color:'#cbd5e1' } } }
        }
      });

      // Defects chart
      if(this.defectChart){ this.defectChart.destroy(); }
      this.defectChart = new Chart(document.getElementById('defectChart'), {
        type:'line',
        data:{ datasets:[
          {label:'Open defects', data:this.raw.defectsDaily.map(r=>({x:r.date,y:+r.openDefects})),
           borderColor:'#34d399', backgroundColor:'#34d399', pointRadius:2, tension:.25}
        ]},
        options:{
          responsive:true, maintainAspectRatio:false, animation:false,
          scales:{ x:{ type:'time', time:{ unit:'day' }, grid:{ color:'rgba(255,255,255,.06)'} },
                  y:{ beginAtZero:true, grid:{ color:'rgba(255,255,255,.06)'} } },
          plugins:{ legend:{ position:'bottom', labels:{ color:'#cbd5e1' } } }
        }
      });
    },

    filterIssues(){
      const plat = this.filters.platform;
      const keep = new Set(['Blocker','Critical']);
      this.issues = (this.raw.issues || [])
        .filter(i => keep.has((i.priority||'').trim()))
        .filter(i => !plat || i.platform === plat);
    },

    // --- AI Status (client-side stub) ---
    generateAIStatus(){
      // For now: synthesize a concise leadership note from available data.
      // Later: replace with serverless call to your LLM.
      const plat = this.filters.platform || 'All platforms';
      const md = [
        `**Summary (${plat})**`,
        `• Executed ${this.fmtPct(this.kpis.executedPct)}, Pass ${this.fmtPct(this.kpis.passPct)}. Open defects ${this.kpis.openDefects} (${this.kpis.critical} blocker/critical).`,
        `• Execution trending ${this.trendText('exec')} and defects ${this.trendText('def')}.`,
        ``,
        `**Highlights**`,
        `• Most planned scenarios executed; quality trending positively.`,
        `• Key dates on track; no change to Go/No-Go.`,
        ``,
        `**Risks & Blockers**`,
        `${this.issues.length ? '• Active blockers/criticals require attention (see table below).' : '• No Blocker/Critical reported currently.'}`,
        ``,
        `**Next Steps**`,
        `• Close remaining critical defects; re-test impacted flows.`,
        `• Prepare demo materials ahead of Alpha Demo.`,
      ].join('\n');

      // Render very lightly to HTML (bold + bullets)
      this.aiStatus = this.mdToHtml(md);
    },

    copyAI(){ if(this.aiStatus){ navigator.clipboard.writeText(this.htmlToText(this.aiStatus)); } },
    downloadAI(){
      const text = this.aiStatus ? this.htmlToText(this.aiStatus) : '';
      const blob = new Blob([text], {type:'text/markdown'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `UAT_Daily_Status_${(this.lastUpdate||'').replace(/[: ]/g,'_')}.md`;
      a.click(); URL.revokeObjectURL(a.href);
    },

    // --- Small formatters ---
    fmtPct(v){ return (v??0).toFixed(0)+'%'; },
    kpiColor(v){ return v>=90 ? 'text-emerald-400' : (v>=70 ? 'text-amber-300' : 'text-rose-400'); },
    sevBadge(p){ return `border-color:rgba(255,255,255,.12);`; },
    sevDot(p){
      const c = p==='Blocker' ? '#fb7185' : p==='Critical' ? '#fca5a5' : '#f59e0b';
      return `background:${c}`;
    },

    trendText(kind){
      // naive delta over last 3 points
      try{
        if(kind==='exec'){
          const arr = this.raw.progressDaily.slice(-3).map(r=>+r.executedPct);
          if(arr.length<2) return 'steady';
          const d = arr[arr.length-1] - arr[0];
          return d>0 ? 'up' : (d<0 ? 'down' : 'steady');
        }else{
          const arr = this.raw.defectsDaily.slice(-3).map(r=>+r.openDefects);
          if(arr.length<2) return 'steady';
          const d = arr[arr.length-1] - arr[0];
          return d<0 ? 'down' : (d>0 ? 'up' : 'steady');
        }
      }catch(_){ return '—'; }
    },

    // minimal MD -> HTML for our bullets/bold
    mdToHtml(md){
      const esc = (s)=>s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
      return esc(md)
        .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
        .replace(/^• /gm,'<li>')
        .replace(/\n{2,}/g,'\n\n')
        .split('\n\n').map(block=>{
          if(block.startsWith('<li>')) return `<ul class="list-disc pl-5 space-y-1">${block.replace(/<li>/g,'<li class="marker:text-slate-400">')}</ul>`;
          return `<p>${block.replace(/\n/g,'<br>')}</p>`;
        }).join('');
    },
    htmlToText(html){ const tmp=document.createElement('div'); tmp.innerHTML=html; return tmp.innerText; }
  }
}
document.addEventListener('alpine:init',()=>{ Alpine.data('app', app) })
</script>
</body>
</html>
